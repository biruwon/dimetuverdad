<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - dimetuverdad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }
        .admin-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .reanalyze-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
        }
        .category-badge {
            border-radius: 20px;
        }
        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }
        .hover-bg-light:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Panel de Administración
                    </h1>
                    <small class="opacity-75">dimetuverdad Admin Dashboard</small>
                </div>
                <div>
                    <a href="{{ url_for('main.index') }}" class="btn btn-light me-2">
                        <i class="fas fa-home me-1"></i>Inicio
                    </a>
                    <a href="{{ url_for('admin.admin_logout') }}" class="btn btn-outline-light">
                        <i class="fas fa-sign-out-alt me-1"></i>Salir
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container my-4">

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card p-4 text-center">
                    <i class="fas fa-tweet fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.total_tweets or 0 }}</h3>
                    <small>Total Tweets</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card p-4 text-center">
                    <i class="fas fa-microscope fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.analyzed_tweets or 0 }}</h3>
                    <small>Analizados</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card p-4 text-center">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.pattern_analyzed or 0 }}</h3>
                    <small>Por Patrones</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card p-4 text-center">
                    <i class="fas fa-robot fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.local_llm_analyzed or 0 }}</h3>
                    <small>Por LLM Local</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Reanalysis Tools -->
            <div class="col-md-6 mb-4">
                <div class="card admin-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sync-alt me-2"></i>Herramientas
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin.admin_reanalyze') }}" class="mb-3">
                            <div class="input-group mb-2">
                                <select name="category" class="form-select" required>
                                    <option value="">Seleccionar categoría para reanalizar...</option>
                                    {% for category in categories %}
                                        <option value="{{ category.category }}">{{ category.category }} ({{ category.count }} tweets)</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="action" value="category">
                                <button type="submit" class="btn btn-outline-primary" onclick="return confirm('Esto reanalizar hasta 20 tweets de la categoría seleccionada.\n¿Continuar?')">
                                    <i class="fas fa-tags me-1"></i>Reanalizar Categoría
                                </button>
                            </div>
                            <small class="text-muted">Reanaliza todos los tweets actualmente clasificados en esta categoría</small>
                        </form>

                        <form method="POST" action="{{ url_for('admin.admin_reanalyze') }}">
                            <div class="input-group mb-2">
                                <input type="text" name="username" class="form-control username-input" placeholder="Nombre de usuario (sin @)" required list="usernames-list">
                                <input type="hidden" name="action" value="user">
                                <button type="submit" class="btn btn-outline-primary" onclick="return confirm('Esto reanalizar TODOS los tweets del usuario especificado.\n¿Continuar?')">
                                    <i class="fas fa-user me-1"></i>Reanalizar Usuario
                                </button>
                            </div>
                            <small class="text-muted">Reanaliza todos los tweets del usuario especificado</small>
                        </form>

                        <form method="POST" action="{{ url_for('admin.admin_fetch') }}" class="mb-3 border rounded p-3 bg-light">
                            <label class="form-label fw-bold text-secondary">
                                <i class="fas fa-download me-1"></i>Obtener Solo Datos (sin análisis)
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" name="username" class="form-control username-input" placeholder="Nombre de usuario (sin @)" required list="usernames-list">
                                <input type="number" name="max" class="form-control" placeholder="Máx. tweets (opcional)" min="1" max="10000">
                                <input type="hidden" name="action" value="fetch_only">
                                <button type="submit" class="btn btn-outline-secondary" onclick="return confirm('Esto obtendrá tweets del usuario especificado SIN analizarlos.\n\n• Si el usuario ya existe: obtendrá solo contenido nuevo\n• Si es nuevo: obtendrá todo el historial disponible\n\n¿Continuar?')">
                                    <i class="fas fa-download me-1"></i>Ejecutar
                                </button>
                            </div>
                            <small class="text-muted">Obtiene tweets del usuario sin análisis automático (actualización incremental)</small>
                        </form>

                        <form method="POST" action="{{ url_for('admin.admin_fetch') }}" class="mb-3 border rounded p-3 bg-light">
                            <label class="form-label fw-bold text-primary">
                                <i class="fas fa-user-plus me-1"></i>Obtener y Analizar
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" name="username" class="form-control username-input" placeholder="Nombre de usuario (sin @)" required list="usernames-list">
                                <input type="number" name="max" class="form-control" placeholder="Máx. tweets (opcional)" min="1" max="10000">
                                <input type="hidden" name="action" value="fetch_and_analyze">
                                <button type="submit" class="btn btn-outline-primary" onclick="return confirm('Esto obtendrá tweets del usuario especificado Y los analizará automáticamente.\n\n• Si el usuario ya existe: obtendrá solo contenido nuevo\n• Si es nuevo: obtendrá todo el historial disponible\n• Se analizarán automáticamente los tweets obtenidos\n\n¿Continuar?')">
                                    <i class="fas fa-play me-1"></i>Ejecutar
                                </button>
                            </div>
                            <small class="text-muted">Obtiene tweets del usuario y los analiza automáticamente (actualización incremental)</small>
                        </form>

                        <form method="POST" action="{{ url_for('admin.admin_fetch') }}" class="mb-3 border rounded p-3 bg-warning bg-opacity-10">
                            <label class="form-label fw-bold text-danger">
                                <i class="fas fa-sync-alt me-1"></i>Recargar Usuario Completo
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" name="username" class="form-control username-input" placeholder="Nombre de usuario (sin @)" required list="usernames-list">
                                <input type="number" name="max" class="form-control" placeholder="Máx. tweets (opcional)" min="1" max="10000">
                                <input type="hidden" name="action" value="refetch_all">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('⚠️ ADVERTENCIA: Esto ELIMINARÁ todos los datos existentes del usuario y los reobtendrá desde cero.\n\n• Se borrarán TODOS los tweets del usuario\n• Se borrarán TODOS los análisis del usuario\n• Se reobtendrá todo el historial disponible\n• Esta acción NO se puede deshacer\n\n¿Estás seguro de continuar?')">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Recargar Todo
                                </button>
                            </div>
                            <small class="text-danger">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                <strong>¡CUIDADO!</strong> Elimina todos los datos existentes del usuario y los vuelve a descargar desde cero
                            </small>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Data Export Tools -->
            <div class="col-md-6 mb-4">
                <div class="card admin-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-download me-2"></i>Obtener Datos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('admin.export_csv') }}" class="btn btn-outline-success" target="_blank">
                                <i class="fas fa-file-csv me-2"></i>Exportar como CSV
                            </a>
                            <small class="text-muted">Formato CSV para Excel, Google Sheets, etc.</small>
                        </div>
                        
                        <hr>
                        
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('admin.export_json') }}" class="btn btn-outline-success" target="_blank">
                                <i class="fas fa-file-code me-2"></i>Exportar como JSON
                            </a>
                            <small class="text-muted">Formato JSON completo con todos los metadatos.</small>
                        </div>
                        
                        <div class="mt-3 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Incluye {{ stats.analyzed_tweets or 0 }} registros de análisis con contenido completo de tweets.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="col-md-6 mb-4">
                <div class="card admin-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribución por Categorías
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for category in categories %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                {% if category.category %}
                                <a href="{{ url_for('admin.admin_view_category', category_name=category.category) }}" class="text-decoration-none" title="Ver todos los tweets de esta categoría">
                                    <span class="badge category-badge bg-{{ 
                                        'danger' if category.category == 'hate_speech' else
                                        'warning' if category.category == 'disinformation' else
                                        'dark' if category.category == 'conspiracy_theory' else
                                        'danger' if category.category == 'anti_immigration' else
                                        'danger' if category.category == 'anti_lgbtq' else
                                        'danger' if category.category == 'anti_feminism' else
                                        'primary' if category.category == 'nationalism' else
                                        'primary' if category.category == 'anti_government' else
                                        'dark' if category.category == 'historical_revisionism' else
                                        'info' if category.category == 'political_general' else
                                        'success' if category.category == 'call_to_action' else
                                        'secondary' if category.category == 'general' else
                                        'info'
                                    }}" style="cursor: pointer;">
                                        {{ category.category }} <i class="fas fa-external-link-alt ms-1 small"></i>
                                    </span>
                                </a>
                                {% else %}
                                <span class="badge category-badge bg-secondary" title="Categoría sin nombre">
                                    Sin categoría <i class="fas fa-exclamation-triangle ms-1 small"></i>
                                </span>
                                {% endif %}
                                <strong>{{ category.count }}</strong>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card admin-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Actividad Reciente
                        </h5>
                        <a href="{{ url_for('admin.admin_view_feedback') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-comments me-1"></i>Ver Todo el Feedback
                        </a>
                    </div>
                    <div class="card-body recent-activity">
                        {% for analysis in recent_analyses %}
                            <div class="border-bottom py-2 hover-bg-light" style="cursor: pointer;" {% if analysis.activity_type == 'analysis' and analysis.post_id %}onclick="window.open('{{ url_for('admin.admin_edit_analysis', tweet_id=analysis.post_id) }}', '_blank')"{% endif %}>
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <small class="text-muted">{{ analysis.analysis_timestamp[:16].replace('T', ' ') if analysis.analysis_timestamp else '' }}</small>
                                    </div>
                                    <div class="col-md-2">
                                        {% if analysis.activity_type == 'feedback' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-comment me-1"></i>{{ analysis.feedback_type }}
                                            </span>
                                        {% elif analysis.activity_type == 'fetch' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-download me-1"></i>Fetch
                                            </span>
                                        {% else %}
                                            <span class="badge bg-{{ 
                                                'danger' if analysis.category == 'hate_speech' else
                                                'warning' if analysis.category == 'disinformation' else
                                                'dark' if analysis.category == 'conspiracy_theory' else
                                                'danger' if analysis.category == 'anti_immigration' else
                                                'danger' if analysis.category == 'anti_lgbtq' else
                                                'danger' if analysis.category == 'anti_feminism' else
                                                'primary' if analysis.category == 'nationalism' else
                                                'primary' if analysis.category == 'anti_government' else
                                                'dark' if analysis.category == 'historical_revisionism' else
                                                'info' if analysis.category == 'political_general' else
                                                'success' if analysis.category == 'call_to_action' else
                                                'secondary' if analysis.category == 'general' else
                                                'info'
                                            }}">
                                                {{ analysis.category }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        {% if analysis.username %}
                                        <a href="{{ url_for('main.user_page', username=analysis.username) }}" class="text-decoration-none" onclick="event.stopPropagation();">
                                            <strong>@{{ analysis.username }}</strong> <i class="fas fa-external-link-alt small"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">Sin usuario</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        {% if analysis.activity_type == 'feedback' %}
                                            <small>
                                                <strong>{{ analysis.original_category }} → {{ analysis.corrected_category }}</strong><br>
                                                {{ analysis.content_preview }}
                                            </small>
                                        {% elif analysis.activity_type == 'fetch' %}
                                            <small>
                                                <strong>{{ analysis.tweet_count }} tweets obtenidos</strong><br>
                                                {{ analysis.content_preview }}
                                            </small>
                                        {% else %}
                                            <small>{{ analysis.content_preview }}...</small>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 text-end">
                                        {% if analysis.activity_type == 'feedback' %}
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-user-edit me-1"></i>Feedback
                                            </span>
                                        {% elif analysis.activity_type == 'fetch' %}
                                            <span class="badge bg-success text-white">
                                                <i class="fas fa-download me-1"></i>Fetch
                                            </span>
                                        {% elif analysis.analysis_stages %}
                                            {% if 'external' in analysis.analysis_stages %}
                                                <span class="badge bg-success text-white" title="Análisis externo con Gemini">
                                                    <i class="fas fa-star me-1"></i>Gemini
                                                </span>
                                            {% elif 'local_llm' in analysis.analysis_stages %}
                                                <span class="badge bg-info text-white" title="Análisis local con LLM">
                                                    <i class="fas fa-brain me-1"></i>LLM
                                                </span>
                                            {% elif 'pattern' in analysis.analysis_stages %}
                                                <span class="badge bg-secondary text-white" title="Detección por patrones">
                                                    <i class="fas fa-search me-1"></i>Patrones
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ analysis.analysis_stages or 'N/A' }}</span>
                                        {% endif %}
                                        {% if analysis.activity_type == 'analysis' %}
                                            <i class="fas fa-external-link-alt ms-1 text-muted small" title="Ver tweets de este usuario en esta categoría"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Username autocomplete datalist -->
    <datalist id="usernames-list">
    </datalist>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // Load usernames for autocomplete
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/usernames')
                .then(response => response.json())
                .then(usernames => {
                    const datalist = document.getElementById('usernames-list');
                    usernames.forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        datalist.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading usernames for autocomplete:', error);
                });
        });
    </script>
</body>
</html>