{% macro render_tweet_display(tweet, show_admin_controls=false, referrer=None, tweet_id=None) %}
<div class="tweet-card {% if tweet.analysis_category %}analysis-{{ tweet.analysis_category }}{% endif %}{% if tweet.is_rt %} rt-{{ tweet.rt_type }}{% endif %}{% if tweet.is_deleted %} deleted{% endif %}{% if tweet.is_edited %} edited{% endif %}">
    <div class="card-body">
        <!-- Post Status Warnings -->
        {% if tweet.post_status_warnings %}
        <div class="post-status-warnings mb-3">
            {% for warning in tweet.post_status_warnings %}
            <div class="alert {{ warning.class }} alert-sm py-2">
                <i class="{{ warning.icon }} me-2"></i>
                <strong>{{ warning.message }}</strong>
                {% if warning.type == 'deleted' %}
                    - Mostrando contenido guardado
                {% elif warning.type == 'edited' %}
                    - <a href="#" class="alert-link show-versions" data-tweet-id="{{ tweet.tweet_id }}">Ver versiones anteriores</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- RT Header (if applicable) -->
        {% if tweet.is_rt %}
        <div class="rt-header mb-2">
            {% if tweet.rt_type == 'repost_other' %}
            <div class="alert alert-info py-2">
                <i class="fas fa-retweet me-2"></i>
                <strong>Retweet de @{{ tweet.original_author or 'usuario' }}</strong>
                {% if tweet.original_tweet_id %}
                <small class="ms-2">
                    <a href="https://x.com/i/web/status/{{ tweet.original_tweet_id }}"
                       target="_blank" class="alert-link">
                        Ver original <i class="fas fa-external-link-alt"></i>
                    </a>
                </small>
                {% endif %}
            </div>
            {% elif tweet.rt_type == 'repost_own' %}
            <div class="alert alert-success py-2">
                <i class="fas fa-retweet me-2"></i>
                <strong>Retweet propio</strong>
            </div>
            {% elif tweet.rt_type == 'repost_reply' %}
            <div class="alert alert-warning py-2">
                <i class="fas fa-reply me-2"></i>
                <strong>Repost Reply de @{{ tweet.reply_to_username or 'usuario' }}</strong>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Tweet Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h6 class="mb-1">
                    <i class="fab fa-twitter text-primary me-2"></i>
                    @{{ tweet.username }}
                    {% if tweet.profile_pic_url %}
                    <img src="{{ tweet.profile_pic_url }}"
                         alt="@{{ tweet.username }}"
                         class="rounded-circle ms-2"
                         width="20"
                         height="20"
                         style="object-fit: cover;">
                    {% endif %}
                </h6>
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    {% if tweet.tweet_timestamp %}
                        {{ tweet.tweet_timestamp[:19].replace('T', ' ') }}
                    {% endif %}
                    {% if tweet.post_type and tweet.post_type != 'original' %}
                        <span class="ms-2 badge bg-secondary">{{ tweet.post_type }}</span>
                    {% endif %}
                    {% if tweet.is_deleted %}
                        <span class="ms-2 badge bg-danger">Eliminado</span>
                    {% endif %}
                    {% if tweet.is_edited %}
                        <span class="ms-2 badge bg-warning text-dark">Editado</span>
                    {% endif %}
                </small>
            </div>

            <!-- Multi-Category Analysis Display -->
            {% if tweet.categories_detected %}
            <div class="category-badges-container mb-2">
                {% for category in tweet.categories_detected %}
                <span class="badge category-{{ category }} category-badge text-white me-1 {% if category == tweet.analysis_category %}primary-badge{% else %}secondary-badge{% endif %}">
                    {% if category == 'hate_speech' %}üö´ Discurso de Odio
                    {% elif category == 'disinformation' %}‚ùå Desinformaci√≥n
                    {% elif category == 'conspiracy_theory' %}üïµÔ∏è Conspiraci√≥n
                    {% elif category == 'far_right_bias' %}‚ö° Sesgo Extremista
                    {% elif category == 'call_to_action' %}üì¢ Llamada a Acci√≥n
                    {% elif category == 'nationalism' %}üè¥ Nacionalismo
                    {% elif category == 'anti_government' %}üèõÔ∏è Anti-Gobierno
                    {% elif category == 'historical_revisionism' %}üìú Revisionismo Hist√≥rico
                    {% elif category == 'political_general' %}üó≥Ô∏è Pol√≠tica General
                    {% else %}‚úÖ General
                    {% endif %}
                </span>
                {% endfor %}

                {% if tweet.has_multiple_categories %}
                <small class="text-muted ms-2">
                    <i class="fas fa-tags"></i> M√∫ltiples categor√≠as detectadas
                </small>
                {% endif %}
            </div>
            {% elif tweet.analysis_category %}
            <!-- Single category display -->
            <div class="category-badges-container mb-2">
                <span class="badge category-{{ tweet.analysis_category }} category-badge text-white primary-badge">
                    {% if tweet.analysis_category == 'hate_speech' %}üö´ Discurso de Odio
                    {% elif tweet.analysis_category == 'disinformation' %}‚ùå Desinformaci√≥n
                    {% elif tweet.analysis_category == 'conspiracy_theory' %}üïµÔ∏è Conspiraci√≥n
                    {% elif tweet.analysis_category == 'far_right_bias' %}‚ö° Sesgo Extremista
                    {% elif tweet.analysis_category == 'call_to_action' %}üì¢ Llamada a Acci√≥n
                    {% elif tweet.analysis_category == 'nationalism' %}üè¥ Nacionalismo
                    {% elif tweet.analysis_category == 'anti_government' %}üèõÔ∏è Anti-Gobierno
                    {% elif tweet.analysis_category == 'historical_revisionism' %}üìú Revisionismo Hist√≥rico
                    {% elif tweet.analysis_category == 'political_general' %}üó≥Ô∏è Pol√≠tica General
                    {% else %}‚úÖ General
                    {% endif %}
                </span>
            </div>
            {% endif %}
        </div>

        <!-- Content Display -->
        <div class="tweet-content-container">
            <!-- Embedded tweet display -->
            {% if not tweet.is_deleted %}
            <div class="embedded-tweet-container">
                <div class="embedded-tweet" data-tweet-url="{{ tweet.tweet_url }}">
                    <iframe
                        src="https://platform.twitter.com/embed/Tweet.html?id={{ tweet.tweet_url.split('/')[-1] if tweet.tweet_url else '' }}&theme=light&lang=es"
                        style="position: static; visibility: visible; width: 100%; height: auto; min-height: 600px; display: block; flex-grow: 1;"
                        title="X Post"
                        frameborder="0"
                        scrolling="no"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
            {% else %}
            <!-- Fallback display for deleted tweets -->
            <div class="deleted-tweet-container border rounded p-3 bg-light">
                <div class="d-flex align-items-start mb-2">
                    <i class="fab fa-twitter text-primary me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong>@{{ tweet.username }}</strong>
                            {% if tweet.tweet_timestamp %}
                            <small class="text-muted ms-2">
                                {{ tweet.tweet_timestamp[:19].replace('T', ' ') }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="tweet-text mb-2">
                            {{ tweet.content }}
                        </div>
                        {% if tweet.hashtags_parsed or tweet.mentions_parsed %}
                        <div class="tweet-metadata mb-2">
                            {% if tweet.hashtags_parsed %}
                            <div class="hashtags mb-1">
                                {% for hashtag in tweet.hashtags_parsed %}
                                <span class="badge bg-primary text-white me-1">#{{ hashtag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if tweet.mentions_parsed %}
                            <div class="mentions">
                                {% for mention in tweet.mentions_parsed %}
                                <span class="badge bg-info text-white me-1">@{{ mention }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if tweet.media_links %}
                        <div class="stored-media mb-2">
                            <small class="text-muted">
                                <i class="fas fa-image me-1"></i>
                                Contenido multimedia almacenado
                            </small>
                            <div class="media-preview mt-1">
                                {% set media_urls = tweet.media_links.split(',') if tweet.media_links else [] %}
                                {% for media_url in media_urls %}
                                {% if media_url.strip() %}
                                <div class="media-item mb-1">
                                    {% if '.mp4' in media_url or '.mov' in media_url or 'video' in media_url %}
                                    <video controls class="img-fluid rounded" style="max-height: 300px;">
                                        <source src="{{ media_url.strip() }}" type="video/mp4">
                                        Tu navegador no soporta el elemento de video.
                                    </video>
                                    {% else %}
                                    <img src="{{ media_url.strip() }}" alt="Media" class="img-fluid rounded" style="max-height: 300px;">
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="deleted-notice mt-2 p-2 bg-warning bg-opacity-10 border border-warning rounded">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Tweet Eliminado:</strong> Este contenido fue eliminado de X/Twitter pero se conserva en nuestra base de datos para fines de an√°lisis.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Analysis Explanation -->
        {% if tweet.analysis_display or tweet.local_explanation or tweet.external_explanation %}
        <div class="analysis-explanation">
            <h6 class="mb-2">
                <i class="fas fa-robot text-primary me-2"></i>
                An√°lisis Autom√°tico
                {% if tweet.analysis_stages %}
                    {% if 'external' in tweet.analysis_stages %}
                        <span class="badge bg-success ms-2" title="An√°lisis externo con Gemini">
                            <i class="fas fa-star me-1"></i>Gemini Multimodal
                        </span>
                    {% elif 'local_llm' in tweet.analysis_stages %}
                        <span class="badge bg-info ms-2" title="An√°lisis local con LLM">
                            <i class="fas fa-brain me-1"></i>LLM Local
                        </span>
                    {% elif 'pattern' in tweet.analysis_stages %}
                        <span class="badge bg-secondary ms-2" title="Detecci√≥n por patrones">
                            <i class="fas fa-search me-1"></i>Patrones
                        </span>
                    {% endif %}
                {% endif %}
            </h6>
            
            <!-- Dual Explanation Display -->
            {% if tweet.local_explanation and tweet.external_explanation %}
            <div class="dual-explanation-container">
                <ul class="nav nav-pills mb-3" id="pills-tab-{{ tweet.tweet_id }}" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-local-tab-{{ tweet.tweet_id }}" data-bs-toggle="pill" 
                                data-bs-target="#pills-local-{{ tweet.tweet_id }}" type="button" role="tab">
                            <i class="fas fa-brain me-1"></i>An√°lisis Local
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-external-tab-{{ tweet.tweet_id }}" data-bs-toggle="pill" 
                                data-bs-target="#pills-external-{{ tweet.tweet_id }}" type="button" role="tab">
                            <i class="fas fa-star me-1"></i>An√°lisis Externo (Gemini)
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="pills-tabContent-{{ tweet.tweet_id }}">
                    <div class="tab-pane fade show active" id="pills-local-{{ tweet.tweet_id }}" role="tabpanel">
                        <p class="mb-0">{{ tweet.local_explanation }}</p>
                    </div>
                    <div class="tab-pane fade" id="pills-external-{{ tweet.tweet_id }}" role="tabpanel">
                        <p class="mb-0">{{ tweet.external_explanation }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <p class="mb-0">{{ tweet.analysis_display }}</p>
            {% endif %}
            
            {% if tweet.analysis_timestamp %}
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Analizado: {{ tweet.analysis_timestamp[:19].replace('T', ' ') }}
            </small>
            {% endif %}

            {% set verification_data = tweet.verification_data %}
            {% if verification_data and verification_data is string %}
                {% set verification_data = verification_data | fromjson %}
            {% endif %}

            {% set has_verification_content = (
                verification_data and (
                    verification_data.get('overall_verdict') or
                    verification_data.get('evidence_sources') or
                    verification_data.get('claims_summary') or
                    verification_data.get('contradictions_found')
                )
            ) %}
            {% if verification_data and (has_verification_content or tweet.analysis_category == 'disinformation') %}
            <div class="mt-3 pt-3 border-top">
                <h6 class="mb-2">
                    <i class="fas fa-search text-info me-2"></i>
                    Verificaci√≥n de Evidencia
                    {% if verification_data.get('confidence_score') %}
                        <span class="badge bg-{{ 'success' if verification_data.confidence_score >= 0.8 else 'warning' if verification_data.confidence_score >= 0.6 else 'danger' }} ms-2">
                            {{ "%.1f"|format(verification_data.confidence_score * 100) }}% Confianza
                        </span>
                    {% endif %}
                </h6>

                {% if verification_data.get('overall_verdict') %}
                <div class="mb-2">
                    <strong class="text-muted">Veredicto general:</strong>
                    <span class="badge bg-{{ 'success' if verification_data.overall_verdict == 'verified' else 'warning' if verification_data.overall_verdict == 'questionable' else 'danger' if verification_data.overall_verdict == 'debunked' else 'secondary' }} ms-2">
                        {% if verification_data.overall_verdict == 'verified' %}‚úÖ Verificado
                        {% elif verification_data.overall_verdict == 'debunked' %}‚ùå Desmentido
                        {% elif verification_data.overall_verdict == 'questionable' %}‚ö†Ô∏è Cuestionable
                        {% elif verification_data.overall_verdict == 'unverified' %}‚ùì Sin Verificar
                        {% else %}{{ verification_data.overall_verdict }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if verification_data.get('claims_summary') %}
                <div class="mb-2">
                    <strong class="text-muted">Resumen de afirmaciones:</strong>
                    <div class="mt-1">
                        {% set summary = verification_data.claims_summary %}
                        {% if summary.total > 0 %}
                        <small class="text-muted">
                            {{ summary.total }} afirmaciones analizadas
                            {% if summary.verified > 0 %} ‚Ä¢ {{ summary.verified }} verificadas{% endif %}
                            {% if summary.debunked > 0 %} ‚Ä¢ {{ summary.debunked }} desmentidas{% endif %}
                            {% if summary.questionable > 0 %} ‚Ä¢ {{ summary.questionable }} cuestionables{% endif %}
                        </small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if verification_data.get('evidence_sources') %}
                <div class="mb-2">
                    <strong class="text-muted">Fuentes consultadas:</strong>
                    <div class="mt-1">
                        {% for source in verification_data.evidence_sources %}
                        <span class="badge bg-{{ 'success' if source.verdict == 'verified' else 'warning' if source.verdict == 'questionable' else 'danger' if source.verdict == 'debunked' else 'light' }} text-{{ 'white' if source.verdict in ['verified', 'debunked'] else 'dark' }} me-1 mb-1">
                            {% if source.verdict == 'verified' %}‚úÖ
                            {% elif source.verdict == 'debunked' %}‚ùå
                            {% elif source.verdict == 'questionable' %}‚ö†Ô∏è
                            {% else %}‚ùì{% endif %}
                            {{ source.name }}
                            {% if source.credibility %}
                            <small>({{ "%.0f"|format(source.credibility * 100) }}%)</small>
                            {% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if verification_data.get('contradictions_found') %}
                <div class="mb-2">
                    <strong class="text-danger">Contradicciones encontradas:</strong>
                    <ul class="list-unstyled mt-1">
                        {% for contradiction in verification_data.contradictions_found %}
                        <li class="text-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>{{ contradiction }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if not verification_data.get('temporal_consistency', True) %}
                <div class="mb-2">
                    <strong class="text-warning">‚ö†Ô∏è Inconsistencias temporales:</strong>
                    <small class="text-muted">Las fechas y eventos mencionados no siguen una secuencia l√≥gica.</small>
                </div>
                {% endif %}

                {% if not has_verification_content and tweet.analysis_category == 'disinformation' %}
                <div class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Este contenido clasificado como desinformaci√≥n no pudo ser verificado con fuentes disponibles.
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if show_admin_controls %}
            <div class="admin-controls mt-3 border-top pt-3">
                <h6 class="text-warning mb-2">
                    <i class="fas fa-shield-alt me-1"></i>Admin Controls
                </h6>
                <a href="{{ url_for('admin.admin_edit_analysis', tweet_id=tweet_id or tweet.tweet_id, from=referrer) }}" class="btn btn-sm btn-warning">
                    <i class="fas fa-edit me-1"></i>Editar An√°lisis
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Tweet Actions -->
        <div class="tweet-actions mt-3">
            <a href="{{ tweet.tweet_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-external-link-alt me-1"></i>
                Ver en X
            </a>
            <button class="btn btn-outline-info btn-sm ms-2" onclick="openFeedbackModal('{{ tweet.tweet_id }}', '{{ tweet.analysis_category or 'general' }}')">
                <i class="fas fa-comment-dots me-1"></i>
                Feedback
            </button>
        </div>
    </div>
</div>
{% endmacro %}