<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@{{ username }} - dimetuverdad</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Twitter Widgets -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --dark-color: #34495e;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.2s ease-in-out;
            margin-bottom: 1.5rem;
        }
        
        .tweet-card {
            border-left: 4px solid #1da1f2;
            background: #fafafa;
        }
        
        /* Enhanced RT styling */
        .tweet-card.rt-repost_other { 
            border-left-color: #1da1f2;
            background: linear-gradient(135deg, #e3f2fd 0%, #fafafa 100%);
        }
        .tweet-card.rt-repost_own { 
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8 0%, #fafafa 100%);
        }
    /* .tweet-card.rt-quote removed - 'quote' post_type removed from taxonomy */
        
        /* Deleted post styling */
        .tweet-card.deleted {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #fafafa 100%);
            opacity: 0.85;
        }
        
        /* Edited post styling */
        .tweet-card.edited {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #fafafa 100%);
        }
        
        .tweet-card.analysis-hate_speech { border-left-color: #dc3545; }
        .tweet-card.analysis-disinformation { border-left-color: #fd7e14; }
        .tweet-card.analysis-conspiracy_theory { border-left-color: #6f42c1; }
        .tweet-card.analysis-far_right_bias { border-left-color: #e83e8c; }
        .tweet-card.analysis-call_to_action { border-left-color: #20c997; }
        .tweet-card.analysis-nationalism { border-left-color: #795548; }
        .tweet-card.analysis-anti_government { border-left-color: #607d8b; }
        .tweet-card.analysis-historical_revisionism { border-left-color: #8bc34a; }
        .tweet-card.analysis-political_general { border-left-color: #2196f3; }
        .tweet-card.analysis-general { border-left-color: #6c757d; }
        
        .stats-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .category-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }
        
        /* Consolidated category colors (10 categories) */
        .category-hate_speech { background-color: #dc3545; }
        .category-disinformation { background-color: #fd7e14; }
        .category-conspiracy_theory { background-color: #6f42c1; }
        .category-far_right_bias { background-color: #e83e8c; }
        .category-call_to_action { background-color: #20c997; }
        .category-nationalism { background-color: #795548; }
        .category-anti_government { background-color: #607d8b; }
        .category-historical_revisionism { background-color: #8bc34a; color: #212529; }
        .category-political_general { background-color: #2196f3; }
        .category-general { background-color: #6c757d; }
        
        /* Multi-category badge styles */
        .category-badges-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .primary-badge {
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        
        .secondary-badge {
            opacity: 0.85;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        .engagement-metric {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .engagement-metric i {
            margin-right: 4px;
        }
        
        .tweet-content {
            line-height: 1.6;
            margin: 1rem 0;
            /* Remove any height restrictions to allow full post display */
            max-height: none !important;
            overflow: visible !important;
        }
        
        .hashtag {
            color: #1da1f2;
            text-decoration: none;
        }
        
        .mention {
            color: #1da1f2;
            text-decoration: none;
        }
        
        .analysis-explanation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .media-preview {
            max-width: 100%;
            /* Remove max-height to allow full image display */
            max-height: none !important;
            object-fit: contain;
            border-radius: 8px;
            margin: 0.5rem;
        }
        
        .embedded-tweet {
            max-width: 100%;
            margin: 1rem 0;
        }
        
        .fallback-content {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-arrow-left me-2"></i>
                dimetuverdad
            </a>
            <div class="navbar-nav ms-auto">
                {% if session.admin_authenticated %}
                    <a href="{{ url_for('admin_dashboard') }}" class="nav-link text-success me-3">
                        <i class="fas fa-shield-alt me-1"></i>Admin Panel
                    </a>
                    <a href="{{ url_for('admin_logout') }}" class="nav-link text-muted me-3">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                {% endif %}
                <span class="navbar-text">
                    <i class="fab fa-twitter text-primary me-1"></i>
                    @{{ username }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    {% if user_profile_pic or (tweets_data.tweets and tweets_data.tweets[0].profile_pic_url) %}
                    <img src="{{ user_profile_pic or tweets_data.tweets[0].profile_pic_url }}" 
                         alt="@{{ username }}" 
                         class="rounded-circle me-3" 
                         width="60" 
                         height="60"
                         style="object-fit: cover;">
                    {% endif %}
                    <div>
                        <h1 class="display-6 mb-2">
                            <i class="fab fa-twitter text-primary me-3"></i>
                            @{{ username }}
                        </h1>
                        <p class="text-muted mb-0">
                            Análisis detallado del contenido político
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simplified Statistics Overview - Only Analyzed Posts -->
        {% if stats.basic %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-12">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-brain text-success fs-2 me-3"></i>
                                    <div>
                                        <div class="h2 mb-1 text-success">{{ stats.basic.analyzed_posts or 0 }}</div>
                                        <div class="text-muted">Posts Analizados</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Category Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-filter text-primary me-2"></i>
                            Filtrar por Categoría
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="?" class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                <i class="fas fa-list me-1"></i>Todos
                            </a>
                            <a href="?category=hate_speech" class="btn btn-sm {% if current_category == 'hate_speech' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                🚫 Discurso de Odio
                            </a>
                            <a href="?category=disinformation" class="btn btn-sm {% if current_category == 'disinformation' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                ❌ Desinformación
                            </a>
                            <a href="?category=conspiracy_theory" class="btn btn-sm {% if current_category == 'conspiracy_theory' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                                🕵️ Conspiración
                            </a>
                            <a href="?category=far_right_bias" class="btn btn-sm {% if current_category == 'far_right_bias' %}btn-info{% else %}btn-outline-info{% endif %}">
                                ⚡ Sesgo Extremista
                            </a>
                            <a href="?category=call_to_action" class="btn btn-sm {% if current_category == 'call_to_action' %}btn-success{% else %}btn-outline-success{% endif %}">
                                📢 Llamada a Acción
                            </a>
                            <a href="?category=political_general" class="btn btn-sm {% if current_category == 'political_general' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                🗳️ Política General
                            </a>
                            <a href="?category=general" class="btn btn-sm {% if current_category == 'general' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                                ✅ General
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Type Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-th-list text-primary me-2"></i>
                            Filtrar por Tipo de Post
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            {# Keep any existing category or page query params when switching post_type #}
                            {% set base_qs = [] %}
                            {% if current_category %}
                                {% set base_qs = base_qs + ['category=' ~ current_category] %}
                            {% endif %}
                            {% if tweets_data.page and tweets_data.page > 1 %}
                                {% set base_qs = base_qs + ['page=' ~ tweets_data.page] %}
                            {% endif %}

                            {% set qs_prefix = '?' if base_qs|length == 0 else '?' ~ (base_qs|join('&')) ~ '&' %}

                            <a href="{{ qs_prefix }}post_type=all" class="btn btn-sm {% if not request.args.get('post_type') or request.args.get('post_type') == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                Todos
                            </a>
                            <a href="{{ qs_prefix }}post_type=original" class="btn btn-sm {% if request.args.get('post_type') == 'original' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                                Originales
                            </a>
                            <a href="{{ qs_prefix }}post_type=repost_other" class="btn btn-sm {% if request.args.get('post_type') == 'repost_other' %}btn-info{% else %}btn-outline-info{% endif %}">
                                Reposts
                            </a>
                            {# removed repost_own filter: we don't scrape/store self-reposts #}
                            {# 'quote' post type removed; list 'repost_reply' as a specialized type #}
                            <a href="{{ qs_prefix }}post_type=repost_reply" class="btn btn-sm {% if request.args.get('post_type') == 'repost_reply' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                Repost Replies
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Charts -->
        <div class="row mb-4">
            {% if stats.analysis %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-brain text-primary me-2"></i>
                            Análisis de Contenido
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="analysisChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Tweets -->
        <div class="row">
            <div class="col-12 d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">
                    <i class="fas fa-comments text-secondary me-2"></i>
                    Tweets Analizados
                    {% if current_category %}
                    <span class="badge bg-secondary ms-2">Filtrado: {{ current_category|title|replace('_', ' ') }}</span>
                    {% endif %}
                </h3>
                <div>
                    {% if tweets_data.total_pages > 1 %}
                    <small class="text-muted">
                        Página {{ tweets_data.page }} de {{ tweets_data.total_pages }} 
                        ({{ tweets_data.total_tweets }} tweets)
                    </small>
                    {% else %}
                    <small class="text-muted">({{ tweets_data.tweets|length }} tweets encontrados)</small>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if tweets_data.tweets %}
        <div class="row">
            {% for tweet in tweets_data.tweets %}
            <div class="col-12 mb-4">
                <div class="card tweet-card {% if tweet.analysis_category %}analysis-{{ tweet.analysis_category }}{% endif %}{% if tweet.is_rt %} rt-{{ tweet.rt_type }}{% endif %}{% if tweet.is_deleted %} deleted{% endif %}{% if tweet.is_edited %} edited{% endif %}">
                    <div class="card-body">
                        <!-- Post Status Warnings -->
                        {% if tweet.post_status_warnings %}
                        <div class="post-status-warnings mb-3">
                            {% for warning in tweet.post_status_warnings %}
                            <div class="alert {{ warning.class }} alert-sm py-2">
                                <i class="{{ warning.icon }} me-2"></i>
                                <strong>{{ warning.message }}</strong>
                                {% if warning.type == 'deleted' %}
                                    - Mostrando contenido guardado
                                {% elif warning.type == 'edited' %}
                                    - <a href="#" class="alert-link show-versions" data-tweet-id="{{ tweet.tweet_id }}">Ver versiones anteriores</a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- RT Header (if applicable) -->
                        {% if tweet.is_rt %}
                        <div class="rt-header mb-2">
                            {% if tweet.rt_type == 'repost_other' %}
                            <div class="alert alert-info py-2">
                                <i class="fas fa-retweet me-2"></i>
                                <strong>Retweet de @{{ tweet.original_author or 'usuario' }}</strong>
                                {% if tweet.original_tweet_id %}
                                <small class="ms-2">
                                    <a href="https://x.com/i/web/status/{{ tweet.original_tweet_id }}" 
                                       target="_blank" class="alert-link">
                                        Ver original <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </small>
                                {% endif %}
                            </div>
                            {% elif tweet.rt_type == 'repost_own' %}
                            <div class="alert alert-success py-2">
                                <i class="fas fa-retweet me-2"></i>
                                <strong>Retweet propio</strong>
                            </div>
                            {% elif tweet.rt_type == 'repost_reply' %}
                            <div class="alert alert-warning py-2">
                                <i class="fas fa-reply me-2"></i>
                                <strong>Repost Reply de @{{ tweet.reply_to_username or 'usuario' }}</strong>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Tweet Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fab fa-twitter text-primary me-2"></i>
                                    @{{ username }}
                                    {% if tweet.profile_pic_url %}
                                    <img src="{{ tweet.profile_pic_url }}" 
                                         alt="@{{ username }}" 
                                         class="rounded-circle ms-2" 
                                         width="20" 
                                         height="20"
                                         style="object-fit: cover;">
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if tweet.tweet_timestamp %}
                                        {{ tweet.tweet_timestamp[:19].replace('T', ' ') }}
                                    {% endif %}
                                    {% if tweet.post_type and tweet.post_type != 'original' %}
                                        <span class="ms-2 badge bg-secondary">{{ tweet.post_type }}</span>
                                    {% endif %}
                                    {% if tweet.is_deleted %}
                                        <span class="ms-2 badge bg-danger">Eliminado</span>
                                    {% endif %}
                                    {% if tweet.is_edited %}
                                        <span class="ms-2 badge bg-warning text-dark">Editado</span>
                                    {% endif %}
                                </small>
                            </div>
                            
                            <!-- Multi-Category Analysis Display -->
                            {% if tweet.categories_detected %}
                            <div class="category-badges-container mb-2">
                                {% for category in tweet.categories_detected %}
                                <span class="badge category-{{ category }} category-badge text-white me-1 {% if category == tweet.analysis_category %}primary-badge{% else %}secondary-badge{% endif %}">
                                    {% if category == 'hate_speech' %}🚫 Discurso de Odio
                                    {% elif category == 'disinformation' %}❌ Desinformación
                                    {% elif category == 'conspiracy_theory' %}🕵️ Conspiración
                                    {% elif category == 'far_right_bias' %}⚡ Sesgo Extremista
                                    {% elif category == 'call_to_action' %}📢 Llamada a Acción
                                    {% elif category == 'nationalism' %}🏴 Nacionalismo
                                    {% elif category == 'anti_government' %}🏛️ Anti-Gobierno
                                    {% elif category == 'historical_revisionism' %}📜 Revisionismo Histórico
                                    {% elif category == 'political_general' %}🗳️ Política General
                                    {% else %}✅ General
                                    {% endif %}
                                </span>
                                {% endfor %}
                                
                                {% if tweet.has_multiple_categories %}
                                <small class="text-muted ms-2">
                                    <i class="fas fa-tags"></i> Múltiples categorías detectadas
                                </small>
                                {% endif %}
                            </div>
                            {% elif tweet.analysis_category %}
                            <!-- Fallback to single category for backward compatibility -->
                            <div class="category-badges-container mb-2">
                                <span class="badge category-{{ tweet.analysis_category }} category-badge text-white primary-badge">
                                    {% if tweet.analysis_category == 'hate_speech' %}🚫 Discurso de Odio
                                    {% elif tweet.analysis_category == 'disinformation' %}❌ Desinformación
                                    {% elif tweet.analysis_category == 'conspiracy_theory' %}🕵️ Conspiración
                                    {% elif tweet.analysis_category == 'far_right_bias' %}⚡ Sesgo Extremista
                                    {% elif tweet.analysis_category == 'call_to_action' %}📢 Llamada a Acción
                                    {% else %}✅ General
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Content Display: Embedded Tweet or Fallback -->
                        <div class="embedded-tweet-container">
                            {% if tweet.is_deleted %}
                            <!-- Always show fallback content for deleted tweets -->
                            <div class="fallback-content">
                                <div class="tweet-content">
                                    <!-- RT Content Display -->
                                    {% if tweet.is_rt and tweet.original_content %}
                                    <div class="original-tweet-content mb-3 p-3 border-start border-3 border-primary bg-light">
                                        <h6 class="text-primary mb-2">
                                            <i class="fas fa-quote-left me-1"></i>
                                            Contenido original{% if tweet.original_author %} de @{{ tweet.original_author }}{% endif %}:
                                        </h6>
                                        <p class="mb-0">{{ tweet.original_content }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <p>{{ tweet.content }}</p>
                                    
                                    <!-- Hashtags -->
                                    {% if tweet.hashtags_parsed %}
                                    <div class="mb-2">
                                        {% for hashtag in tweet.hashtags_parsed %}
                                        <span class="hashtag me-2">#{{ hashtag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Mentions -->
                                    {% if tweet.mentions_parsed %}
                                    <div class="mb-2">
                                        {% for mention in tweet.mentions_parsed %}
                                        <span class="mention me-2">@{{ mention }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Media -->
                                    {% if tweet.media_links %}
                                    <div class="media-container mb-2">
                                        {% for media_url in tweet.media_links.split(',') %}
                                        {% if media_url.strip() %}
                                            {% if media_url.endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                            <img src="{{ media_url.strip() }}" alt="Media" class="media-preview" loading="lazy">
                                            {% else %}
                                            <a href="{{ media_url.strip() }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fas fa-external-link-alt me-1"></i>Ver Media
                                            </a>
                                            {% endif %}
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <!-- Try to embed first, fallback if failed -->
                            <div class="embedded-tweet" data-tweet-url="{{ tweet.tweet_url }}">
                                <iframe 
                                    src="https://platform.twitter.com/embed/Tweet.html?dnt=true&embedId=twitter-widget-0&features=eyJ0ZndfdGltZWxpbmVfbGlzdCI6eyJidWNrZXQiOlsibGlua3RyLmVlIiwidHIuZWUiLCJ0ZXJyYS5jb20uYnIiLCJ3d3cubGlua3RyLmVlIiwid3d3LnRyLmVlIiwid3d3LnRlcnJhLmNvbS5iciJdLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X2hvcml6b25fdGltZWxpbmVfMTIwMzQiOnsiYnVja2V0IjoidHJlYXRtZW50IiwidmVyc2lvbiI6bnVsbH0sInRmd190d2VldF9lZGl0X2JhY2tlbmQiOnsiYnVja2V0Ijoib24iLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X3JlZnNyY19zZXNzaW9uIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19jaGluX3BpbGxzXzE0NzQxIjp7ImJ1Y2tldCI6ImNvbnRyb2wiLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X21peGVkX21lZGlhXzE1ODk3Ijp7ImJ1Y2tldCI6InRyZWF0bWVudCIsInZlcnNpb24iOm51bGx9LCJ0Zndfc3BhY2VfY2FyZCI6eyJidWNrZXQiOiJvZmYiLCJ2ZXJzaW9uIjpudWxsfX0%3D&frame=false&hideCard=false&hideThread=false&id={{ tweet.tweet_url.split('/')[-1] }}&lang=es&origin={{ request.url_root|urlencode }}&sessionId=a47c7ee76b8ad407be2a6a4b659a78a6e82a7749&theme=light&widgetsVersion=1&width=550px"
                                    style="position: static; visibility: visible; width: 100%; height: auto; min-height: 300px; display: block; flex-grow: 1;"
                                    title="X Post"
                                    frameborder="0"
                                    scrolling="no"
                                    allowfullscreen>
                                </iframe>
                            </div>
                            
                            <!-- Fallback content (shown if tweet fails to load) -->
                            <div class="fallback-content" style="display: none;">
                                <div class="tweet-content">
                                    <!-- RT Content Display -->
                                    {% if tweet.is_rt and tweet.original_content %}
                                    <div class="original-tweet-content mb-3 p-3 border-start border-3 border-primary bg-light">
                                        <h6 class="text-primary mb-2">
                                            <i class="fas fa-quote-left me-1"></i>
                                            Contenido original{% if tweet.original_author %} de @{{ tweet.original_author }}{% endif %}:
                                        </h6>
                                        <p class="mb-0">{{ tweet.original_content }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    <p>{{ tweet.content }}</p>
                                    
                                    <!-- Hashtags -->
                                    {% if tweet.hashtags_parsed %}
                                    <div class="mb-2">
                                        {% for hashtag in tweet.hashtags_parsed %}
                                        <span class="hashtag me-2">#{{ hashtag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Mentions -->
                                    {% if tweet.mentions_parsed %}
                                    <div class="mb-2">
                                        {% for mention in tweet.mentions_parsed %}
                                        <span class="mention me-2">@{{ mention }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Media -->
                                    {% if tweet.media_links %}
                                    <div class="media-container mb-2">
                                        {% for media_url in tweet.media_links.split(',') %}
                                        {% if media_url.strip() %}
                                            {% if media_url.endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                            <img src="{{ media_url.strip() }}" alt="Media" class="media-preview" loading="lazy">
                                            {% else %}
                                            <a href="{{ media_url.strip() }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fas fa-external-link-alt me-1"></i>Ver Media
                                            </a>
                                            {% endif %}
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Embed no disponible:</strong> Mostrando contenido guardado en su lugar.
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Analysis Explanation -->
                        {% if tweet.analysis_display %}
                        <div class="analysis-explanation">
                            <h6 class="mb-2">
                                <i class="fas fa-robot text-primary me-2"></i>
                                Análisis Automático
                                {% if tweet.analysis_method %}
                                    <span class="badge bg-{{ 'success' if tweet.analysis_method == 'llm' else 'secondary' }} ms-2">
                                        {{ 'LLM' if tweet.analysis_method == 'llm' else 'Patrones' }}
                                    </span>
                                {% endif %}
                            </h6>
                            <p class="mb-0">{{ tweet.analysis_display }}</p>
                            {% if tweet.analysis_timestamp %}
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Analizado: {{ tweet.analysis_timestamp[:19].replace('T', ' ') }}
                            </small>
                            {% endif %}
                            
                            {% if session.admin_authenticated %}
                            <div class="admin-controls mt-3 border-top pt-3">
                                <h6 class="text-warning mb-2">
                                    <i class="fas fa-shield-alt me-1"></i>Admin Controls
                                </h6>
                                <a href="{{ url_for('admin_edit_analysis', tweet_id=tweet.tweet_id, from=request.url) }}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit me-1"></i>Editar Análisis
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Tweet Actions -->
                        <div class="tweet-actions mt-3">
                            <a href="{{ tweet.tweet_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Ver en X
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if tweets_data.total_pages > 1 %}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Tweet pagination">
                    <ul class="pagination justify-content-center">
                        {% if tweets_data.page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tweets_data.page - 1 }}{% if current_category %}&category={{ current_category }}{% endif %}">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in range(1, tweets_data.total_pages + 1) %}
                            {% if page_num == tweets_data.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% elif page_num <= 3 or page_num > tweets_data.total_pages - 3 or (page_num >= tweets_data.page - 1 and page_num <= tweets_data.page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_num }}{% if current_category %}&category={{ current_category }}{% endif %}">{{ page_num }}</a>
                            </li>
                            {% elif page_num == 4 and tweets_data.page > 5 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% elif page_num == tweets_data.total_pages - 3 and tweets_data.page < tweets_data.total_pages - 4 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if tweets_data.page < tweets_data.total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tweets_data.page + 1 }}{% if current_category %}&category={{ current_category }}{% endif %}">
                                Siguiente<i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No hay tweets disponibles</h5>
                        <p class="text-muted">No se encontraron tweets para esta cuenta.</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Analysis Chart
        {% if stats.analysis %}
        const analysisData = {
            labels: [
                {% for item in stats.analysis %}
                '{{ item.category|title }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for item in stats.analysis %}
                    {{ item.count }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: ['#dc3545', '#fd7e14', '#6f42c1', '#e83e8c', '#20c997', '#795548', '#607d8b', '#8bc34a', '#2196f3', '#6c757d']
            }]
        };

        const analysisCtx = document.getElementById('analysisChart').getContext('2d');
        new Chart(analysisCtx, {
            type: 'doughnut',
            data: analysisData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        {% endif %}

        // Enhanced tweet handling with version support and deleted post management
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize version display handlers
            initializeVersionHandlers();
            
            // Handle Twitter widget loading and fallback
            setTimeout(function() {
                checkEmbeddedTweets();
            }, 3000);
            
            // Check again after 10 seconds for slower networks
            setTimeout(function() {
                checkEmbeddedTweets();
            }, 10000);
            
            // Auto-hide deleted tweet embeds and show fallback content
            handleDeletedTweets();
        });

        function initializeVersionHandlers() {
            // Handle "show versions" links for edited tweets
            document.querySelectorAll('.show-versions').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tweetId = this.getAttribute('data-tweet-id');
                    showTweetVersions(tweetId);
                });
            });
        }

        function showTweetVersions(tweetId) {
            // Fetch tweet versions from API
            fetch(`/api/tweet-versions/${tweetId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error al cargar versiones: ' + data.error);
                        return;
                    }
                    
                    // Create modal to display versions
                    const modal = createVersionModal(data);
                    document.body.appendChild(modal);
                    
                    // Show modal
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                    
                    // Remove modal when hidden
                    modal.addEventListener('hidden.bs.modal', function() {
                        document.body.removeChild(modal);
                    });
                })
                .catch(error => {
                    console.error('Error fetching tweet versions:', error);
                    alert('Error al cargar las versiones del tweet');
                });
        }

        function createVersionModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('tabindex', '-1');
            
            let versionsHtml = '';
            if (data.versions && data.versions.length > 0) {
                data.versions.forEach(function(version, index) {
                    const versionDate = new Date(version.detected_at).toLocaleString('es-ES');
                    versionsHtml += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-history me-2"></i>
                                    Versión ${version.version_number}
                                    <small class="text-muted ms-2">${versionDate}</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p>${version.content}</p>
                                ${version.hashtags ? '<div class="mb-2">' + JSON.parse(version.hashtags).map(tag => '<span class="hashtag me-2">#' + tag + '</span>').join('') + '</div>' : ''}
                                ${version.mentions ? '<div class="mb-2">' + JSON.parse(version.mentions).map(mention => '<span class="mention me-2">@' + mention + '</span>').join('') + '</div>' : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                versionsHtml = '<p class="text-muted">No hay versiones anteriores disponibles.</p>';
            }
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>
                                Historial de Ediciones
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Versión actual:</strong> ${data.current_content}
                            </div>
                            
                            <h6 class="mt-4 mb-3">Versiones anteriores:</h6>
                            ${versionsHtml}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            return modal;
        }

        function handleDeletedTweets() {
            // For deleted tweets, ensure fallback content is always shown
            document.querySelectorAll('.tweet-card.deleted .embedded-tweet').forEach(function(embeddedTweet) {
                const fallback = embeddedTweet.parentNode.querySelector('.fallback-content');
                if (fallback) {
                    embeddedTweet.style.display = 'none';
                    fallback.style.display = 'block';
                }
            });
        }

        function checkEmbeddedTweets() {
            const embeddedTweets = document.querySelectorAll('.embedded-tweet:not(.deleted .embedded-tweet)');
            
            embeddedTweets.forEach(function(container) {
                const tweetFrame = container.querySelector('iframe');
                const fallback = container.parentNode.querySelector('.fallback-content');
                
                if (!tweetFrame || !fallback) return;
                
                let hasShownFallback = false;
                
                // Listen for iframe load events
                tweetFrame.onload = function() {
                    // If iframe loaded, assume success (Twitter embeds handle their own error states)
                    console.log('Tweet iframe loaded successfully');
                };
                
                tweetFrame.onerror = function() {
                    // Only show fallback on explicit error
                    if (!hasShownFallback) {
                        console.log('Tweet iframe failed to load, showing fallback');
                        container.style.display = 'none';
                        fallback.style.display = 'block';
                        hasShownFallback = true;
                    }
                };
                
                // Much longer timeout, and only for obvious failures
                setTimeout(function() {
                    // Only check if iframe is completely missing or has clear failure indicators
                    if (!tweetFrame.src || tweetFrame.src === '' || tweetFrame.src === 'about:blank') {
                        if (!hasShownFallback) {
                            console.log('Tweet iframe has no src or blank, showing fallback');
                            container.style.display = 'none';
                            fallback.style.display = 'block';
                            hasShownFallback = true;
                        }
                    }
                    // Note: We removed the cross-origin checks that were causing false positives
                }, 15000); // Longer timeout (15 seconds)
            });
        }
    </script>
</body>
</html>
