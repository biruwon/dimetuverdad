<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@{{ username }} - dimetuverdad</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Twitter Widgets -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --dark-color: #34495e;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.2s ease-in-out;
            margin-bottom: 1.5rem;
        }
        
        .tweet-card {
            border-left: 4px solid #1da1f2;
            background: #fafafa;
        }
        
        /* Enhanced RT styling */
        .tweet-card.rt-repost_other { 
            border-left-color: #1da1f2;
            background: linear-gradient(135deg, #e3f2fd 0%, #fafafa 100%);
        }
        .tweet-card.rt-repost_own { 
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8 0%, #fafafa 100%);
        }
    /* .tweet-card.rt-quote removed - 'quote' post_type removed from taxonomy */
        
        /* Deleted post styling */
        .tweet-card.deleted {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #fafafa 100%);
            opacity: 0.85;
        }
        
        /* Edited post styling */
        .tweet-card.edited {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff3cd 0%, #fafafa 100%);
        }
        
        .tweet-card.analysis-hate_speech { border-left-color: #dc3545; }
        .tweet-card.analysis-disinformation { border-left-color: #fd7e14; }
        .tweet-card.analysis-conspiracy_theory { border-left-color: #6f42c1; }
        .tweet-card.analysis-anti_immigration { border-left-color: #dc3545; }
        .tweet-card.analysis-anti_lgbtq { border-left-color: #dc3545; }
        .tweet-card.analysis-anti_feminism { border-left-color: #dc3545; }
        .tweet-card.analysis-nationalism { border-left-color: #007bff; }
        .tweet-card.analysis-anti_government { border-left-color: #007bff; }
        .tweet-card.analysis-historical_revisionism { border-left-color: #343a40; }
        .tweet-card.analysis-political_general { border-left-color: #17a2b8; }
        .tweet-card.analysis-call_to_action { border-left-color: #20c997; }
        .tweet-card.analysis-nationalism { border-left-color: #795548; }
        .tweet-card.analysis-anti_government { border-left-color: #607d8b; }
        .tweet-card.analysis-historical_revisionism { border-left-color: #8bc34a; }
        .tweet-card.analysis-political_general { border-left-color: #2196f3; }
        .tweet-card.analysis-general { border-left-color: #6c757d; }
        
        .stats-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .category-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }
        
        /* Consolidated category colors (10 categories) */
        .category-hate_speech { background-color: #dc3545; }
        .category-disinformation { background-color: #fd7e14; }
        .category-conspiracy_theory { background-color: #6f42c1; }
        .category-anti_immigration { background-color: #dc3545; }
        .category-anti_lgbtq { background-color: #dc3545; }
        .category-anti_feminism { background-color: #dc3545; }
        .category-nationalism { background-color: #007bff; }
        .category-anti_government { background-color: #007bff; }
        .category-historical_revisionism { background-color: #343a40; }
        .category-political_general { background-color: #17a2b8; }
        .category-call_to_action { background-color: #20c997; }
        .category-nationalism { background-color: #795548; }
        .category-anti_government { background-color: #607d8b; }
        .category-historical_revisionism { background-color: #8bc34a; color: #212529; }
        .category-political_general { background-color: #2196f3; }
        .category-general { background-color: #6c757d; }
        
        /* Mobile Responsiveness Improvements */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .navbar-nav .nav-link {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            
            .display-6 {
                font-size: 1.8rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.375rem 0.5rem;
                margin-bottom: 0.25rem;
            }
            
            .badge {
                font-size: 0.75rem;
            }
            
            .pagination .page-link {
                padding: 0.375rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .stats-card .d-flex {
                flex-direction: column;
                text-align: center;
                margin-bottom: 1rem;
            }
            
            .stats-card .d-flex:last-child {
                margin-bottom: 0;
            }
            
            .stats-card .fs-2 {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .row {
                --bs-gutter-x: 0.25rem;
            }
            
            .filter-buttons .btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.375rem;
                margin-right: 0.125rem;
                margin-bottom: 0.25rem;
            }
            
            .category-badges-container {
                flex-direction: column;
                align-items: flex-start !important;
            }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .engagement-metric {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .engagement-metric i {
            margin-right: 4px;
        }
        
        .tweet-content {
            line-height: 1.6;
            margin: 1rem 0;
            /* Remove any height restrictions to allow full post display */
            max-height: none !important;
            overflow: visible !important;
        }
        
        .hashtag {
            color: #1da1f2;
            text-decoration: none;
        }
        
        .mention {
            color: #1da1f2;
            text-decoration: none;
        }
        
        .analysis-explanation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .media-preview {
            max-width: 100%;
            /* Remove max-height to allow full image display */
            max-height: none !important;
            object-fit: contain;
            border-radius: 8px;
            margin: 0.5rem;
        }
        
        .tweet-content-container {
            margin: 1rem 0;
        }
        
        .tweet-content-container {
            margin: 1rem 0;
        }
        
        .embedded-tweet-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .embedded-tweet-container {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #fafafa;
        }
        
        .fallback-content {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }

        /* Category Badge Styles */
        .category-badge {
            border-radius: 20px !important;
            padding: 4px 8px !important;
            font-size: 0.8em !important;
            font-weight: 600 !important;
            transition: transform 0.2s ease !important;
        }

        .category-badge:hover {
            transform: scale(1.05) !important;
        }

        /* Primary and Secondary Badge Styles */
        .primary-badge {
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }

        .secondary-badge {
            opacity: 0.8 !important;
        }

        /* Category Color Classes - More Specific */
        .category-hate_speech.category-badge {
            background: linear-gradient(135deg, var(--bs-danger, #dc3545) 0%, var(--bs-danger, #dc3545) 100%) !important;
            color: white !important;
        }

        .category-disinformation.category-badge {
            background: linear-gradient(135deg, var(--bs-warning, #ffc107) 0%, var(--bs-warning, #ffc107) 100%) !important;
            color: black !important;
        }

        .category-conspiracy_theory.category-badge {
            background: linear-gradient(135deg, var(--bs-dark, #6c757d) 0%, var(--bs-dark, #6c757d) 100%) !important;
            color: white !important;
        }

        .category-anti_immigration.category-badge,
        .category-anti_lgbtq.category-badge,
        .category-anti_feminism.category-badge {
            background: linear-gradient(135deg, var(--bs-danger, #dc3545) 0%, var(--bs-danger, #dc3545) 100%) !important;
            color: white !important;
        }

        .category-call_to_action.category-badge {
            background: linear-gradient(135deg, var(--bs-success, #198754) 0%, var(--bs-success, #198754) 100%) !important;
            color: white !important;
        }

        .category-general.category-badge,
        .category-political_general.category-badge,
        .category-nationalism.category-badge,
        .category-anti_government.category-badge,
        .category-historical_revisionism.category-badge {
            background: linear-gradient(135deg, var(--bs-secondary, #6c757d) 0%, var(--bs-secondary, #6c757d) 100%) !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-arrow-left me-2"></i>
                dimetuverdad
            </a>
            <div class="navbar-nav ms-auto">
                {% if session.admin_authenticated %}
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="nav-link text-success me-3">
                        <i class="fas fa-shield-alt me-1"></i>Admin Panel
                    </a>
                    <a href="{{ url_for('admin.admin_logout') }}" class="nav-link text-muted me-3">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                {% endif %}
                <span class="navbar-text">
                    <i class="fab fa-twitter text-primary me-1"></i>
                    @{{ username }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="text-center">
                <div class="loading-spinner"></div>
                <div class="loading-text">Cargando...</div>
            </div>
        </div>
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    {% if user_profile_pic or (tweets_data.tweets and tweets_data.tweets[0].profile_pic_url) %}
                    <img src="{{ user_profile_pic or tweets_data.tweets[0].profile_pic_url }}" 
                         alt="@{{ username }}" 
                         class="rounded-circle me-3" 
                         width="60" 
                         height="60"
                         style="object-fit: cover;">
                    {% endif %}
                    <div>
                        <h1 class="display-6 mb-2">
                            <i class="fab fa-twitter text-primary me-3"></i>
                            @{{ username }}
                        </h1>
                        <p class="text-muted mb-0">
                            An√°lisis detallado del contenido pol√≠tico
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tweets -->
        <div class="row">
            <div class="col-12 d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">
                    <i class="fas fa-comments text-secondary me-2"></i>
                    Tweets Analizados
                    {% if current_category %}
                    <span class="badge bg-secondary ms-2">Filtrado: {{ current_category|title|replace('_', ' ') }}</span>
                    {% endif %}
                </h3>
                <div>
                    {% if tweets_data.total_pages > 1 %}
                    <small class="text-muted">
                        P√°gina {{ tweets_data.page }} de {{ tweets_data.total_pages }} 
                        ({{ tweets_data.total_tweets }} tweets)
                    </small>
                    {% else %}
                    <small class="text-muted">({{ tweets_data.tweets|length }} tweets encontrados)</small>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if tweets_data.tweets %}
        <div class="row">
            {% for tweet in tweets_data.tweets %}
            <div class="col-12 mb-4">
                {% from 'components/tweet_display.html' import render_tweet_display %}
                {{ render_tweet_display(tweet, show_admin_controls=session.admin_authenticated, referrer=request.url, tweet_id=tweet.tweet_id) }}
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if tweets_data.total_pages > 1 %}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Tweet pagination">
                    <ul class="pagination justify-content-center">
                        {% if tweets_data.page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tweets_data.page - 1 }}{% if current_category %}&category={{ current_category }}{% endif %}{% if request.args.get('post_type') %}&post_type={{ request.args.get('post_type') }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in range(1, tweets_data.total_pages + 1) %}
                            {% if page_num == tweets_data.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% elif page_num <= 3 or page_num > tweets_data.total_pages - 3 or (page_num >= tweets_data.page - 1 and page_num <= tweets_data.page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_num }}{% if current_category %}&category={{ current_category }}{% endif %}{% if request.args.get('post_type') %}&post_type={{ request.args.get('post_type') }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ page_num }}</a>
                            </li>
                            {% elif page_num == 4 and tweets_data.page > 5 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% elif page_num == tweets_data.total_pages - 3 and tweets_data.page < tweets_data.total_pages - 4 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if tweets_data.page < tweets_data.total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tweets_data.page + 1 }}{% if current_category %}&category={{ current_category }}{% endif %}{% if request.args.get('post_type') %}&post_type={{ request.args.get('post_type') }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                                Siguiente<i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No hay tweets disponibles</h5>
                        <p class="text-muted">No se encontraron tweets para esta cuenta.</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Simplified Statistics Overview - Only Analyzed Posts -->
        {% if stats.basic %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-12">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-brain text-success fs-2 me-3"></i>
                                    <div>
                                        <div class="h2 mb-1 text-success">{{ stats.basic.analyzed_posts or 0 }}</div>
                                        <div class="text-muted">Posts Analizados</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Compact Filters Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header" id="filtersHeading">
                        <h6 class="mb-0">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" aria-controls="filtersCollapse">
                                <i class="fas fa-filter text-primary me-2"></i>
                                Filtros de B√∫squeda
                                <i class="fas fa-chevron-down ms-2"></i>
                            </button>
                        </h6>
                    </div>
                    <div id="filtersCollapse" class="collapse show" aria-labelledby="filtersHeading">
                        <div class="card-body">
                            <div class="row">
                                <!-- Category Filter -->
                                <div class="col-lg-6 col-xl-3 mb-3">
                                    <h6 class="card-title mb-2">
                                        <i class="fas fa-tags text-primary me-1"></i>
                                        Categor√≠a
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        <a href="?" class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                            <i class="fas fa-list me-1"></i>Todos
                                        </a>
                                        <a href="?category=hate_speech" class="btn btn-sm {% if current_category == 'hate_speech' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                            üö´ Odio
                                        </a>
                                        <a href="?category=disinformation" class="btn btn-sm {% if current_category == 'disinformation' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                            ‚ùå Desinfo
                                        </a>
                                        <a href="?category=conspiracy_theory" class="btn btn-sm {% if current_category == 'conspiracy_theory' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                                            üïµÔ∏è Consp
                                        </a>
                                        <a href="?category=anti_immigration" class="btn btn-sm {% if current_category == 'anti_immigration' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                            üö´ Anti-Imm
                                        </a>
                                        <a href="?category=anti_lgbtq" class="btn btn-sm {% if current_category == 'anti_lgbtq' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                            üè≥Ô∏è‚Äçüåà Anti-LGBTQ
                                        </a>
                                        <a href="?category=anti_feminism" class="btn btn-sm {% if current_category == 'anti_feminism' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                            üë© Anti-Fem
                                        </a>
                                        <a href="?category=nationalism" class="btn btn-sm {% if current_category == 'nationalism' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                            üá™üá∏ Nacional
                                        </a>
                                        <a href="?category=anti_government" class="btn btn-sm {% if current_category == 'anti_government' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                            üèõÔ∏è Anti-Gov
                                        </a>
                                        <a href="?category=historical_revisionism" class="btn btn-sm {% if current_category == 'historical_revisionism' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                                            üìú Revision
                                        </a>
                                        <a href="?category=call_to_action" class="btn btn-sm {% if current_category == 'call_to_action' %}btn-success{% else %}btn-outline-success{% endif %}">
                                            üì¢ Acci√≥n
                                        </a>
                                        <a href="?category=political_general" class="btn btn-sm {% if current_category == 'political_general' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                            üó≥Ô∏è Pol√≠tica
                                        </a>
                                        <a href="?category=general" class="btn btn-sm {% if current_category == 'general' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                                            ‚úÖ General
                                        </a>
                                    </div>
                                </div>

                                <!-- Post Type Filter -->
                                <div class="col-lg-6 col-xl-3 mb-3">
                                    <h6 class="card-title mb-2">
                                        <i class="fas fa-th-list text-primary me-1"></i>
                                        Tipo de Post
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {# Keep any existing category or page query params when switching post_type #}
                                        {% set base_qs = [] %}
                                        {% if current_category %}
                                            {% set base_qs = base_qs + ['category=' ~ current_category] %}
                                        {% endif %}
                                        {% if tweets_data.page and tweets_data.page > 1 %}
                                            {% set base_qs = base_qs + ['page=' ~ tweets_data.page] %}
                                        {% endif %}

                                        {% set qs_prefix = '?' if base_qs|length == 0 else '?' ~ (base_qs|join('&')) ~ '&' %}

                                        <a href="{{ qs_prefix }}post_type=all" class="btn btn-sm {% if not request.args.get('post_type') or request.args.get('post_type') == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                            Todos
                                        </a>
                                        <a href="{{ qs_prefix }}post_type=original" class="btn btn-sm {% if request.args.get('post_type') == 'original' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                                            Originales
                                        </a>
                                        <a href="{{ qs_prefix }}post_type=repost_other" class="btn btn-sm {% if request.args.get('post_type') == 'repost_other' %}btn-info{% else %}btn-outline-info{% endif %}">
                                            Reposts
                                        </a>
                                        {# removed repost_own filter: we don't scrape/store self-reposts #}
                                        {# 'quote' post type removed; list 'repost_reply' as a specialized type #}
                                        <a href="{{ qs_prefix }}post_type=repost_reply" class="btn btn-sm {% if request.args.get('post_type') == 'repost_reply' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                                            Repost Replies
                                        </a>
                                    </div>
                                </div>

                                <!-- Date Range Filter -->
                                <div class="col-lg-6 col-xl-3 mb-3">
                                    <h6 class="card-title mb-2">
                                        <i class="fas fa-calendar text-primary me-1"></i>
                                        Rango de Fechas
                                    </h6>
                                    <form method="GET" class="row g-2">
                                        {# Preserve existing filters #}
                                        {% if current_category %}
                                            <input type="hidden" name="category" value="{{ current_category }}">
                                        {% endif %}
                                        {% if request.args.get('post_type') %}
                                            <input type="hidden" name="post_type" value="{{ request.args.get('post_type') }}">
                                        {% endif %}
                                        
                                        <div class="col-12">
                                            <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" 
                                                   value="{{ date_from or '' }}" placeholder="Desde">
                                        </div>
                                        <div class="col-12">
                                            <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" 
                                                   value="{{ date_to or '' }}" placeholder="Hasta">
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex gap-1">
                                                <button type="submit" class="btn btn-primary btn-sm flex-fill">
                                                    <i class="fas fa-search me-1"></i>Aplicar
                                                </button>
                                                <a href="{{ url_for('main.user_page', username=username) }}{% if current_category %}?category={{ current_category }}{% endif %}" class="btn btn-outline-secondary btn-sm">
                                                    <i class="fas fa-times me-1"></i>Limpiar
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Charts -->
        <div class="row mb-4">
            {% if stats.analysis %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-brain text-primary me-2"></i>
                            An√°lisis de Contenido
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="analysisChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">
                        <i class="fas fa-comment-dots me-2"></i>
                        Ay√∫danos a Mejorar el An√°lisis
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¬øCrees que la clasificaci√≥n de este tweet es incorrecta? Tu feedback nos ayuda a mejorar nuestro sistema de an√°lisis.</p>
                    
                    <form id="feedbackForm">
                        <input type="hidden" id="feedbackTweetId" name="tweet_id">
                        <input type="hidden" id="feedbackOriginalCategory" name="original_category">
                        
                        <div class="mb-3">
                            <label for="feedbackType" class="form-label">Tipo de Feedback</label>
                            <select class="form-select" id="feedbackType" name="feedback_type" required>
                                <option value="correction">Correcci√≥n de Categor√≠a</option>
                                <option value="flag">Reportar Problema</option>
                                <option value="improvement">Sugerencia de Mejora</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="categoryCorrectionGroup">
                            <label for="correctedCategory" class="form-label">Categor√≠a Correcta</label>
                            <select class="form-select" id="correctedCategory" name="corrected_category">
                                <option value="">Seleccionar categor√≠a...</option>
                                <option value="general">‚úÖ General</option>
                                <option value="hate_speech">üö´ Discurso de Odio</option>
                                <option value="disinformation">‚ùå Desinformaci√≥n</option>
                                <option value="conspiracy_theory">üïµÔ∏è Teor√≠a de Conspiraci√≥n</option>
                                <option value="anti_immigration">üö´ Anti-Inmigraci√≥n</option>
                                <option value="anti_lgbtq">üè≥Ô∏è‚Äçüåà Anti-LGBTQ</option>
                                <option value="anti_feminism">üë© Anti-Feminismo</option>
                                <option value="nationalism">üá™üá∏ Nacionalismo</option>
                                <option value="anti_government">üèõÔ∏è Anti-Gubernamental</option>
                                <option value="historical_revisionism">üìú Revisionismo Hist√≥rico</option>
                                <option value="call_to_action">üì¢ Llamada a Acci√≥n</option>
                                <option value="political_general">üó≥Ô∏è Pol√≠tica General</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userComment" class="form-label">Comentario (Opcional)</label>
                            <textarea class="form-control" id="userComment" name="user_comment" rows="3" 
                                      placeholder="Explica por qu√© crees que la clasificaci√≥n es incorrecta o c√≥mo podr√≠amos mejorar..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitFeedback()">
                        <i class="fas fa-paper-plane me-1"></i>
                        Enviar Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Loading state management
        function showLoading(message = 'Cargando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('.loading-text');
            loadingText.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // Show loading on filter clicks and pagination
        document.addEventListener('DOMContentLoaded', function() {
            // Handle filter button clicks with loading states
            const filterButtons = document.querySelectorAll('.filter-buttons .btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    showLoading('Aplicando filtros...');
                });
            });

            // Handle pagination clicks
            const paginationLinks = document.querySelectorAll('.pagination .page-link');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    showLoading('Cargando p√°gina...');
                });
            });
        });

        // Analysis Chart
        {% if stats.analysis %}
        const analysisData = {
            labels: [
                {% for item in stats.analysis %}
                '{{ item.category|title }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for item in stats.analysis %}
                    {{ item.count }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: ['#dc3545', '#fd7e14', '#6f42c1', '#e83e8c', '#20c997', '#795548', '#607d8b', '#8bc34a', '#2196f3', '#6c757d']
            }]
        };

        const analysisCtx = document.getElementById('analysisChart').getContext('2d');
        new Chart(analysisCtx, {
            type: 'doughnut',
            data: analysisData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: window.innerWidth < 768 ? 'bottom' : 'bottom',
                        labels: {
                            font: {
                                size: window.innerWidth < 768 ? 11 : 12
                            }
                        }
                    }
                }
            }
        });
        {% endif %}

        // Enhanced tweet handling with version support and deleted post management
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize version display handlers
            initializeVersionHandlers();
            
            // Handle Twitter widget loading and fallback
            setTimeout(function() {
                checkEmbeddedTweets();
            }, 3000);
            
            // Check again after 10 seconds for slower networks
            setTimeout(function() {
                checkEmbeddedTweets();
            }, 10000);
            
            // Auto-hide deleted tweet embeds and show fallback content
            handleDeletedTweets();
        });

        function checkEmbeddedTweets() {
            // Check if Twitter widgets loaded successfully
            document.querySelectorAll('.embedded-tweet').forEach(function(tweetContainer) {
                const iframe = tweetContainer.querySelector('iframe');
                if (iframe) {
                    // Check if iframe loaded successfully
                    iframe.addEventListener('load', function() {
                        // Tweet loaded successfully
                        tweetContainer.classList.add('loaded');
                    });
                    
                    iframe.addEventListener('error', function() {
                        // Tweet failed to load, show fallback
                        showFallbackContent(tweetContainer);
                    });
                    
                    // Fallback timeout - if tweet doesn't load within 15 seconds, show fallback
                    setTimeout(function() {
                        if (!tweetContainer.classList.contains('loaded')) {
                            showFallbackContent(tweetContainer);
                        }
                    }, 15000);
                }
            });
        }

        function showFallbackContent(tweetContainer) {
            // Check if fallback content already exists
            if (tweetContainer.querySelector('.fallback-content')) {
                return; // Already showing fallback
            }
            
            // Create fallback content display
            const fallback = document.createElement('div');
            fallback.className = 'fallback-content mt-2';
            fallback.innerHTML = `
                <div class="alert alert-info alert-sm py-2 mb-0">
                    <i class="fas fa-external-link-alt me-2"></i>
                    <a href="${tweetContainer.getAttribute('data-tweet-url')}" target="_blank" class="alert-link fw-bold">
                        Ver el tweet completo en X
                    </a>
                </div>
            `;
            
            tweetContainer.appendChild(fallback);
            tweetContainer.classList.add('fallback-shown');
        }

        function initializeVersionHandlers() {
            // Handle "show versions" links for edited tweets
            document.querySelectorAll('.show-versions').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tweetId = this.getAttribute('data-tweet-id');
                    showTweetVersions(tweetId);
                });
            });
        }

        function showTweetVersions(tweetId) {
            // Fetch tweet versions from API
            fetch(`/api/tweet-versions/${tweetId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error al cargar versiones: ' + data.error);
                        return;
                    }
                    
                    // Create modal to display versions
                    const modal = createVersionModal(data);
                    document.body.appendChild(modal);
                    
                    // Show modal
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                    
                    // Remove modal when hidden
                    modal.addEventListener('hidden.bs.modal', function() {
                        document.body.removeChild(modal);
                    });
                })
                .catch(error => {
                    console.error('Error fetching tweet versions:', error);
                    alert('Error al cargar las versiones del tweet');
                });
        }

        function createVersionModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('tabindex', '-1');
            
            let versionsHtml = '';
            if (data.previous_versions && data.previous_versions.length > 0) {
                data.previous_versions.forEach(function(version, index) {
                    const versionDate = new Date(version.detected_at).toLocaleString('es-ES');
                    versionsHtml += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-history me-2"></i>
                                    Versi√≥n ${version.version_number}
                                    <small class="text-muted ms-2">${versionDate}</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p>${version.content}</p>
                                ${version.hashtags ? '<div class="mb-2">' + JSON.parse(version.hashtags).map(tag => '<span class="hashtag me-2">#' + tag + '</span>').join('') + '</div>' : ''}
                                ${version.mentions ? '<div class="mb-2">' + JSON.parse(version.mentions).map(mention => '<span class="mention me-2">@' + mention + '</span>').join('') + '</div>' : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                versionsHtml = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No hay versiones anteriores disponibles para este tweet.</div>';
            }
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2"></i>
                                Historial de Ediciones - Tweet ${data.tweet_id}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Versi√≥n actual (${data.total_versions} versiones totales):</strong><br>
                                ${data.current_version.content}
                            </div>
                            
                            <h6 class="mt-4 mb-3">Versiones anteriores:</h6>
                            ${versionsHtml}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            return modal;
        }

        function handleDeletedTweets() {
            // For deleted tweets, ensure fallback content is always shown
            document.querySelectorAll('.tweet-card.deleted .embedded-tweet').forEach(function(embeddedTweet) {
                const fallback = embeddedTweet.parentNode.querySelector('.fallback-content');
                if (fallback) {
                    embeddedTweet.style.display = 'none';
                    fallback.style.display = 'block';
                }
            });
        }

        function openFeedbackModal(tweetId, originalCategory) {
            document.getElementById('feedbackTweetId').value = tweetId;
            document.getElementById('feedbackOriginalCategory').value = originalCategory;
            
            // Reset form
            document.getElementById('feedbackForm').reset();
            document.getElementById('categoryCorrectionGroup').style.display = 'block';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
            modal.show();
        }

        function submitFeedback() {
            const form = document.getElementById('feedbackForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            if (!data.feedback_type) {
                alert('Por favor selecciona un tipo de feedback.');
                return;
            }
            
            if (data.feedback_type === 'correction' && !data.corrected_category) {
                alert('Por favor selecciona la categor√≠a correcta.');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('#feedbackModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
            submitBtn.disabled = true;
            
            // Submit feedback
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('¬°Gracias! Tu feedback ha sido enviado y nos ayudar√° a mejorar el an√°lisis.');
                    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
                } else {
                    alert('Error: ' + (result.error || 'No se pudo enviar el feedback.'));
                }
            })
            .catch(error => {
                console.error('Error submitting feedback:', error);
                alert('Error al enviar el feedback. Por favor intenta de nuevo.');
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        // Handle feedback type change
        document.getElementById('feedbackType').addEventListener('change', function() {
            const categoryGroup = document.getElementById('categoryCorrectionGroup');
            if (this.value === 'correction') {
                categoryGroup.style.display = 'block';
            } else {
                categoryGroup.style.display = 'none';
            }
        });
    </script>
</body>
</html>
