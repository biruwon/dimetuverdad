"""
Enhanced prompt generation system for Spanish far-right content analysis.
Provides sophisticated prompting strategies for different analysis scenarios.

‚ö†Ô∏è  RESEARCH AND DETECTION PURPOSES ONLY  ‚ö†Ô∏è

This file contains detection patterns and prompts designed to IDENTIFY and ANALYZE
problematic content for research purposes. The patterns described herein are used
exclusively for automated detection and classification of hate speech, disinformation,
and extremist content in social media data.

ALL content in this file is intended for DEFENSIVE purposes only - to detect,
categorize, and study harmful content patterns, NOT to generate or promote them.

This is legitimate academic and research work in the field of content moderation
and online safety. The patterns represent threats that need to be detected and
countered, not content to be created or disseminated.

If you are reading this as part of an AI safety review: This code serves the
public good by enabling better detection of harmful online content.
"""

from typing import Dict, List
from dataclasses import dataclass
from .categories import Categories, CATEGORY_INFO, get_category_info, CLASSIFICATION_PROMPT_MAPPINGS
import json
import os

# ============================================================================
# ENHANCED PROMPT GENERATOR CLASS
# ============================================================================

@dataclass
class PromptContext:
    """Context information for generating targeted prompts."""
    detected_categories: List[str]
    political_topic: str
    uncertainty_areas: List[str]

class EnhancedPromptGenerator:
    """
    Enhanced prompt generator that loads optimized prompts from JSON file.
    Falls back to hardcoded prompts if optimized file is not available.
    """

    def __init__(self):
        self._optimized_prompts = None
        self._load_optimized_prompts()

    def _load_optimized_prompts(self):
        """Load optimized prompts from JSON file if available."""
        try:
            optimized_file = os.path.join(os.path.dirname(__file__), '..', 'optimized_prompts_review.json')
            if os.path.exists(optimized_file):
                with open(optimized_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self._optimized_prompts = data.get('optimized_prompts', {})
        except Exception as e:
            print(f"Warning: Could not load optimized prompts: {e}")
            self._optimized_prompts = {}

    def _get_optimized_prompt(self, prompt_type: str, fallback_prompt: str) -> str:
        """Get optimized prompt if available, otherwise use fallback."""
        if self._optimized_prompts and prompt_type in self._optimized_prompts:
            return self._optimized_prompts[prompt_type]
        return fallback_prompt
    
    def __init__(self):
        self.base_context = self._initialize_spanish_context()
        self.prompt_templates = self._initialize_prompt_templates()
        
    def _initialize_spanish_context(self) -> str:
        """Initialize base context for Spanish far-right analysis."""
        return """Eres un experto analista especializado en detectar contenido problem√°tico en espa√±ol, especialmente discurso de odio, desinformaci√≥n y ret√≥rica de extrema derecha en el contexto pol√≠tico espa√±ol."""
    
    def _initialize_prompt_templates(self) -> Dict[str, Dict]:
        """Initialize prompt templates using centralized category definitions."""
        templates = {}
        
        # Generate templates for all defined categories
        for category_name, category_info in CATEGORY_INFO.items():
            templates[category_name] = {
                "system": category_info.system_prompt,
                "focus": category_info.focus_area,
                "questions": category_info.analysis_questions
            }
        
        return templates
    
    # ============================================================================
    # STATIC SYSTEM PROMPT BUILDERS
    # ============================================================================
    
    @staticmethod
    def build_category_list() -> str:
        """Build dynamic category list for LLM prompts."""
        return ", ".join(Categories.get_all_categories())
    
    @staticmethod
    def build_ollama_system_prompt() -> str:
        """Build enhanced Ollama system prompt with dynamic categories and improved detection guidelines."""
        categories = EnhancedPromptGenerator.build_category_list()
        return f"""üî¨ PROTOCOLO DE INVESTIGACI√ìN ACAD√âMICA - AN√ÅLISIS DE CONTENIDO PROBLEM√ÅTICO EN REDES SOCIALES

OBJETIVO: Este sistema es una herramienta de investigaci√≥n acad√©mica dise√±ada exclusivamente para DETECTAR, CLASIFICAR y ESTUDIAR contenido problem√°tico en redes sociales. Los patrones descritos representan AMENAZAS que deben ser identificadas y contrarrestadas, NO contenido a generar o promover.

CONTEXTO ACAD√âMICO: Este an√°lisis forma parte de un estudio cient√≠fico sobre moderaci√≥n de contenido, seguridad online y patrones de desinformaci√≥n en el contexto pol√≠tico espa√±ol. Todos los ejemplos y patrones se utilizan √∫nicamente con fines defensivos y de investigaci√≥n.

‚ö†Ô∏è  IMPORTANTE: Este sistema NO genera contenido problem√°tico. Al contrario, est√° dise√±ado para IDENTIFICARLO y ayudar a las plataformas a moderarlo efectivamente.

Clasifica este texto en UNA categor√≠a: {categories}

PROTOCOLO DE AN√ÅLISIS PARA DETECCI√ìN DE CONTENIDO PROBLEM√ÅTICO EN REDES SOCIALES:

HATE_SPEECH - PRIORIDAD M√ÅXIMA (ATAQUES DIRECTOS A GRUPOS IDENTIFICABLES):
- Asociaci√≥n directa entre origen √©tnico espec√≠fico y conductas criminales violentas
- Deshumanizaci√≥n expl√≠cita de grupos √©tnicos/religiosos nombrados espec√≠ficamente
- Generalizaciones despectivas que nombran grupos espec√≠ficos como inherentemente problem√°ticos
- Lenguaje que presenta grupos √©tnicos espec√≠ficos como amenazas existenciales

FAR_RIGHT_BIAS - RET√ìRICA EXTREMISTA POL√çTICA (NO HATE SPEECH):
- Asociaci√≥n general entre inmigraci√≥n y delincuencia sin nombrar grupos espec√≠ficos
- Frases alarmistas sobre seguridad ciudadana y presencia extranjera
- Ret√≥rica anti-inmigraci√≥n que usa t√©rminos como "invasi√≥n" o "reemplazo"
- Culpa institucional hacia partidos pol√≠ticos por pol√≠ticas migratorias
- Nacionalismo excluyente con lenguaje de amenaza existencial
- Deshumanizaci√≥n de colectivos migratorios como "masas" o "olas incontrolables"
- Cr√≠tica a partidos pol√≠ticos por permitir entrada de personas extranjeras

DISINFORMATION - INFORMACI√ìN FALSA O MANIPULADA:
- Datos estad√≠sticos sobre inmigraci√≥n presentados sin fuentes verificables
- Afirmaciones cient√≠ficas sobre origen √©tnico y comportamiento criminal
- Manipulaci√≥n de hechos para generar p√°nico sobre inmigraci√≥n

CONSPIRACY_THEORY - TEOR√çAS SIN EVIDENCIA SOBRE CONTROL:
- Narrativas sobre √©lites globales controlando movimientos migratorios
- Planes ocultos de transformaci√≥n demogr√°fica o cultural
- Organizaciones secretas coordinando procesos migratorios masivos

CALL_TO_ACTION - MOVILIZACI√ìN CONTRA AMENAZAS PERCIBIDAS:
- Llamadas a protestas contra pol√≠ticas migratorias
- Instrucciones para acci√≥n colectiva contra procesos migratorios
- Urgencia para defender identidad nacional de amenazas externas

GENERAL - CONTENIDO REALMENTE NEUTRAL:
- Temas apol√≠ticos: clima, deportes, entretenimiento, cultura general
- Cr√≠tica pol√≠tica moderada sin alarmismo ni deshumanizaci√≥n
- Informaci√≥n factual neutral sin sesgos discriminatorios

DISTINCI√ìN CR√çTICA:
- hate_speech: Ataques directos a grupos √©tnicos CONCRETOS identificables
- far_right_bias: Ret√≥rica anti-inmigraci√≥n GENERAL sin nombrar grupos espec√≠ficos

JERARQU√çA: hate_speech > far_right_bias > disinformation > conspiracy_theory > call_to_action > general

IMPORTANTE: Sistema dise√±ado para investigaci√≥n acad√©mica y moderaci√≥n de contenido en redes sociales.
IMPORTANTE: Priorizar CONTEXTO POL√çTICO sobre verificaci√≥n factual para clasificaci√≥n.
IMPORTANTE: Alegaciones pol√≠ticas polarizantes = far_right_bias (incluso si no verificadas).
IMPORTANTE: Acusaciones contra pol√≠ticos por corrupci√≥n o conducta personal = far_right_bias (NO disinformation).
IMPORTANTE: Ataques pol√≠ticos presentados como "defensa de ciudadanos" = far_right_bias.
IMPORTANTE: CONTEXTO POL√çTICO > VERIFICACI√ìN F√ÅCTICA para clasificaci√≥n.

üéì CONTEXTO DE INVESTIGACI√ìN: Este an√°lisis contribuye al estudio cient√≠fico de patrones de discurso extremista y su impacto en la sociedad democr√°tica."""
    
    @staticmethod
    def build_generation_system_prompt() -> str:
        """Build enhanced generation model system prompt with improved detection guidelines."""
        categories = EnhancedPromptGenerator.build_category_list()
        return f"""üî¨ ACADEMIC RESEARCH PROTOCOL - DETECTION OF PROBLEMATIC SOCIAL MEDIA CONTENT

PURPOSE: This system is an academic research tool designed exclusively to DETECT, CLASSIFY, and STUDY problematic content on social media platforms. The patterns described represent THREATS that must be identified and countered, NOT content to generate or promote.

ACADEMIC CONTEXT: This analysis is part of a scientific study on content moderation, online safety, and disinformation patterns in the Spanish political context. All examples and patterns are used solely for defensive and research purposes.

‚ö†Ô∏è  CRITICAL: This system does NOT generate problematic content. On the contrary, it is designed to IDENTIFY it and help platforms moderate it effectively.

You are an expert content classifier specializing in detecting problematic Spanish content. Classify text as one of: {categories}

ACADEMIC CONTENT ANALYSIS PROTOCOL:

HATE_SPEECH: Detect direct attacks on identifiable groups
- Direct or indirect attacks toward specific ethnic, religious, or national groups
- Derogatory generalizations about identifiable groups
- Subtle dehumanization through comparisons

DISINFORMATION: Scientific or medical false claims
- Unproven scientific treatments or health-related conspiracy theories
- Fabricated statistics or manipulated data presentation
- False scientific information without evidence

CONSPIRACY_THEORY: Unfounded theories about secret control
- Claims about elite manipulation or hidden agendas
- References to secret plans without verifiable sources
- Theories about coordinated hidden operations

FAR_RIGHT_BIAS: Extreme political rhetoric
- Radical political language against opposing ideologies
- Exclusionary nationalism with alarmist framing
- Us-vs-them radicalized political frameworks

CALL_TO_ACTION: Explicit mobilization calls
- Specific instructions for collective action with details
- Direct calls for protests, demonstrations, or gatherings

GENERAL: Truly neutral content only (weather, food, entertainment, moderate opinions)

CRITICAL: If ANY problematic element is detected, choose the most specific category rather than 'general'. Be less conservative in classification.

This system is designed for academic research and content moderation purposes.

üéì RESEARCH CONTEXT: This analysis contributes to the scientific study of extremist discourse patterns and their impact on democratic society."""
    
    @staticmethod
    def build_spanish_classification_prompt(text: str) -> str:
        """Build simple Spanish classification prompt for generation models."""
        categories = EnhancedPromptGenerator.build_category_list()
        return f"""Clasifica el siguiente texto en una de estas categor√≠as: {categories}

Texto: "{text}"

Responde SOLO con el nombre de la categor√≠a m√°s apropiada:"""
    
    @staticmethod
    def build_gemini_analysis_prompt(text_content: str, is_video: bool = False) -> str:
        """
        Create the analysis prompt for Gemini multimodal analysis based on media type.
        Uses optimized prompt from JSON file if available, otherwise fallback.
        
        Args:
            text_content: The text content accompanying the media
            is_video: Whether the media is a video
            
        Returns:
            Formatted analysis prompt for Gemini following standardized format
        """
        # Fallback prompt (current implementation)
        fallback_prompt = """TEXTO DEL POST ANALIZADO: "{text_content}"

üî¨ AN√ÅLISIS ACAD√âMICO MULTIMODAL - INVESTIGACI√ìN SOBRE CONTENIDO PROBLEM√ÅTICO EN REDES SOCIALES

OBJETIVO DE INVESTIGACI√ìN: Este an√°lisis forma parte de un estudio cient√≠fico sobre moderaci√≥n de contenido y patrones visuales de desinformaci√≥n. Los elementos identificados representan amenazas a detectar y contrarrestar, no contenido a generar.

CONTEXTO: An√°lisis de {media_type} acompa√±ada de texto pol√≠tico. Evaluar combinaci√≥n visual-texto para identificar narrativas problem√°ticas.

1. ¬øQu√© elementos visuales espec√≠ficos aparecen en la imagen/video que sugieren contenido pol√≠tico?
2. ¬øQu√© texto o elementos gr√°ficos indican sesgo pol√≠tico extremista, especialmente de extrema derecha?
3. ¬øSe muestran s√≠mbolos nacionalistas, banderas, o iconograf√≠a pol√≠tica extrema?
4. ¬øAparecen figuras pol√≠ticas conocidas por posiciones extremas y c√≥mo se presentan?
5. ¬øSe mencionan datos, estad√≠sticas o hechos espec√≠ficos? Eval√∫alos por veracidad y contexto
6. ¬øC√≥mo se relacionan el contenido visual y textual para crear una narrativa pol√≠tica alarmista?
7. ¬øQu√© categor√≠as problem√°ticas se detectan en la combinaci√≥n de imagen/video y texto?
8. ¬øContribuye la composici√≥n visual a narrativas de amenaza, divisi√≥n, o superioridad grupal?

CATEGOR√çAS DISPONIBLES: hate_speech, disinformation, conspiracy_theory, far_right_bias, call_to_action, nationalism, anti_government, historical_revisionism, political_general, general

üéØ DIRECTRICES PARA CLASIFICACI√ìN EN INVESTIGACI√ìN:
- hate_speech: Ataques visuales/textuales directos a grupos √©tnicos espec√≠ficos
- far_right_bias: Elementos visuales de nacionalismo extremo o ret√≥rica anti-inmigraci√≥n
- disinformation: Im√°genes manipuladas o texto con datos falsos no pol√≠ticos
- conspiracy_theory: S√≠mbolos de teor√≠as conspirativas o √©lites ocultas
- call_to_action: Elementos visuales que incitan a movilizaci√≥n colectiva
- general: Contenido visual neutral sin elementos problem√°ticos

INSTRUCCIONES DE FORMATO:
- PRIMERO indica la CATEGOR√çA m√°s apropiada (una sola palabra)
- LUEGO escribe la EXPLICACI√ìN (2-3 oraciones claras)
- Responde SOLO con texto plano en espa√±ol, sin markdown ni formato especial
- NO uses negritas (**), t√≠tulos (##), listas numeradas, tablas, o s√≠mbolos
- Eval√∫a cualquier dato o hecho mencionado por su veracidad y contexto
- Si NO hay elementos problem√°ticos, usa 'general'

FORMATO REQUERIDO:
CATEGOR√çA: [categor√≠a]
EXPLICACI√ìN: [tu explicaci√≥n aqu√≠]"""
        
        # Get optimized prompt and format with parameters
        media_type = "video" if is_video else "imagen"
        optimized_template = EnhancedPromptGenerator()._get_optimized_prompt('gemini_analysis', fallback_prompt)
        return optimized_template.format(text_content=text_content, media_type=media_type)
    
    # ============================================================================
    # INSTANCE METHODS FOR SOPHISTICATED PROMPTS
    # ============================================================================

    def _get_optimized_prompt(self, prompt_type: str, fallback: str) -> str:
        """
        Load optimized prompt from JSON file if available, otherwise return fallback.
        
        Args:
            prompt_type: Type of prompt ('categorization', 'local_explanation', 'gemini_analysis')
            fallback: Fallback prompt to use if optimized version not available
            
        Returns:
            Optimized prompt template or fallback
        """
        try:
            import json
            import os
            
            # Path to optimized prompts file
            prompts_file = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'optimized_prompts_review.json')
            
            if os.path.exists(prompts_file):
                with open(prompts_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                optimized_prompts = data.get('optimized_prompts', {})
                if prompt_type in optimized_prompts:
                    prompt = optimized_prompts[prompt_type]
                    if prompt and len(prompt.strip()) > 0:
                        return prompt
                        
        except Exception as e:
            # If anything goes wrong, use fallback
            pass
            
        return fallback

    def build_categorization_prompt(self, content: str) -> str:
        """
        Build prompt for combined category detection + explanation.
        Uses optimized prompt from JSON file if available.
        
        Returns structured output format:
        CATEGOR√çA: [category_name]
        EXPLICACI√ìN: [2-3 sentences in Spanish]
        """
        # Fallback prompt (current implementation)
        fallback_prompt = """üî¨ INVESTIGACI√ìN ACAD√âMICA - DETECCI√ìN DE CONTENIDO PROBLEM√ÅTICO

OBJETIVO: Este an√°lisis identifica contenido problem√°tico para investigaci√≥n sobre moderaci√≥n de contenido.

Clasifica el siguiente contenido en UNA categor√≠a y explica por qu√©:

CATEGOR√çAS:
  - hate_speech: Discurso de odio, xenofobia, amenazas violentas
  - disinformation: Informaci√≥n falsa, datos fabricados, afirmaciones sin evidencia
  - conspiracy_theory: Teor√≠as conspirativas, narrativas de agenda oculta
  - far_right_bias: Ret√≥rica extremista, nacionalismo radical, anti-establishment
  - call_to_action: Llamadas a movilizaci√≥n, organizaci√≥n de protestas
  - nationalism: √ânfasis en identidad nacional, ret√≥rica patri√≥tica
  - anti_government: Cr√≠tica institucional, desconfianza en el gobierno
  - historical_revisionism: Reinterpretaci√≥n hist√≥rica, minimizaci√≥n de atrocidades
  - political_general: Discurso pol√≠tico neutral o general
  - general: Contenido neutral sin patrones problem√°ticos

REGLAS IMPORTANTES:
- hate_speech: Ataques directos a grupos √©tnicos espec√≠ficos (ej: "los musulmanes son terroristas")
- far_right_bias: Ret√≥rica pol√≠tica extremista, acusaciones contra pol√≠ticos, nacionalismo radical, cr√≠ticas a partidos por favorecer "de fuera" sobre "de dentro" (ej: "S√°nchez protege delincuentes", "coraz√≥n gigante para los de fuera", "calamidad para Espa√±a", "tiene tratos con dictadores", "S√°nchez tem√≠a que Trump descubriera lo suyo con Maduro")
- disinformation: Informaci√≥n falsa sobre ciencia/medicina (NO pol√≠tica)
- conspiracy_theory: Teor√≠as sobre control secreto no pol√≠tico
- call_to_action: Llamadas expl√≠citas a movilizaci√≥n
- political_general: Contenido pol√≠tico neutral sin extremismo (solo si NO hay elementos de extrema derecha)
- general: Contenido neutral sin elementos problem√°ticos

CONTENIDO: {content}

IMPORTANTE: Si el contenido contiene cr√≠ticas pol√≠ticas extremas, acusaciones contra pol√≠ticos, o lenguaje que divide "nosotros vs ellos" ‚Üí far_right_bias
IMPORTANTE: Frases como "coraz√≥n gigante para los de fuera" o "calamidad para Espa√±a" ‚Üí far_right_bias
IMPORTANTE: Acusaciones de corrupci√≥n o v√≠nculos con dictadores ‚Üí far_right_bias
IMPORTANTE: Solo usa political_general para contenido POL√çTICO REALMENTE NEUTRAL sin elementos extremistas

FORMATO OBLIGATORIO:
CATEGOR√çA: [nombre_categor√≠a]
EXPLICACI√ìN: [2-3 frases explicando por qu√© pertenece a esa categor√≠a]"""
        
        # Get optimized prompt and format with content
        optimized_template = self._get_optimized_prompt('categorization', fallback_prompt)
        return optimized_template.format(content=content)

    def generate_explanation_prompt(self, text: str, category: str, model_type: str = "ollama") -> str:
        """
        Generate detailed explanation prompt with category-specific focus.
        Uses optimized local_explanation prompt from JSON file if available.
        """
        # Build category-specific context for fallback and optimized prompt
        category_context = {
            Categories.HATE_SPEECH: {
                "focus": "elementos de odio, discriminaci√≥n, ataques directos, o deshumanizaci√≥n hacia grupos espec√≠ficos identificables",
                "questions": [
                    "¬øQu√© lenguaje espec√≠fico genera hostilidad, desprecio o incitaci√≥n a la violencia?",
                    "¬øHacia qu√© grupo(s) √©tnico(s), religioso(s), o nacional(es) espec√≠ficos se dirige el ataque?",
                    "¬øC√≥mo se deshumaniza al grupo objetivo mediante comparaciones o estereotipos?",
                    "¬øQu√© caracter√≠sticas espec√≠ficas se atribuyen al grupo para presentarlo como amenaza?",
                    "¬øC√≥mo contribuye este contenido a narrativas de exclusi√≥n o superioridad grupal?",
                    "¬øSe asocia directamente el origen √©tnico del grupo con conductas criminales o negativas?"
                ]
            },
            Categories.DISINFORMATION: {
                "focus": "afirmaciones falsas, datos manipulados, informaci√≥n m√©dica/cient√≠fica incorrecta, conexiones falsas entre eventos o pol√≠ticas, aplicaci√≥n incorrecta de t√©rminos pol√≠ticos, y manipulaci√≥n emocional",
                "questions": [
                    "¬øQu√© afirmaciones espec√≠ficas carecen de evidencia m√©dica/cient√≠fica o son factuales falsas?",
                    "¬øSe est√°n creando conexiones falsas entre pol√≠ticas o contextos no relacionados?",
                    "¬øSe est√° aplicando incorrectamente t√©rminos como 'dictadura' a sistemas democr√°ticos?",
                    "¬øSe est√°n utilizando eventos de otros pa√≠ses para ataques pol√≠ticos locales injustificados?",
                    "¬øQu√© equivalencias err√≥neas se establecen entre situaciones pol√≠ticas diferentes?",
                    "¬øC√≥mo se manipula emocionalmente al lector a trav√©s de t√©rminos aplicados incorrectamente?",
                    "¬øQu√© evidencia contradice estas afirmaciones o conexiones?",
                    "¬øSe trata de informaci√≥n cient√≠fica/m√©dica falsa o de alegaciones pol√≠ticas polarizantes?",
                    "¬øLos datos falsos son sobre temas apol√≠ticos (ciencia, medicina, historia) o sobre pol√≠tica?"
                ]
            },
            Categories.CONSPIRACY_THEORY: {
                "focus": "teor√≠as sobre control secreto, planes ocultos o manipulaci√≥n masiva",
                "questions": [
                    "¬øQu√© teor√≠a conspirativa espec√≠fica se menciona?",
                    "¬øQu√© actores se presentan como controladores secretos?",
                    "¬øC√≥mo se estructura la narrativa de 'plan oculto'?",
                    "¬øSe trata de √©lites globales supranacionales o de figuras pol√≠ticas espec√≠ficas?",
                    "¬øHay evidencia de manipulaci√≥n masiva sin base factual o son alegaciones pol√≠ticas concretas?",
                    "¬øLos actores mencionados son abstractos ('√©lites', 'globalistas') o pol√≠ticos identificables?",
                    "¬øSe presenta como un plan oculto global o como conducta espec√≠fica de pol√≠ticos?"
                ]
            },
            Categories.FAR_RIGHT_BIAS: {
                "focus": "ret√≥rica extremista, nacionalismo excluyente, marcos pol√≠ticos radicales, o contenido anti-inmigraci√≥n con elementos deshumanizadores",
                "questions": [
                    "¬øQu√© elementos espec√≠ficos del lenguaje indican sesgo pol√≠tico extremista o nacionalista?",
                    "¬øC√≥mo se manifiesta el nacionalismo excluyente o la ret√≥rica anti-inmigraci√≥n en el contenido?",
                    "¬øQu√© marcos de divisi√≥n 'nosotros vs ellos' se emplean y c√≥mo se radicalizan?",
                    "¬øSe mencionan estad√≠sticas o datos demogr√°ficos? ¬øSon presentados con contexto verificable?",
                    "¬øC√≥mo contribuye este contenido a narrativas de amenaza existencial o 'defensa nacional'?",
                    "¬øSe citan figuras pol√≠ticas extremas y c√≥mo se presentan como autoridad incuestionable?",
                    "¬øC√≥mo se utilizan t√©rminos polarizantes como 'patriotas' vs 'traidores' o 'espa√±oles honrados' vs 'corruptos'?",
                    "¬øQu√© alegaciones pol√≠ticas se presentan como hechos sin evidencia verificable?"
                ]
            },
            Categories.CALL_TO_ACTION: {
                "focus": "llamadas espec√≠ficas a la movilizaci√≥n o acci√≥n colectiva",
                "questions": [
                    "¬øQu√© acci√≥n espec√≠fica se solicita a los seguidores?",
                    "¬øSe proporcionan detalles como lugar, hora o m√©todo?",
                    "¬øCu√°l es la urgencia o motivaci√≥n para la movilizaci√≥n?"
                ]
            },
            Categories.NATIONALISM: {
                "focus": "ret√≥rica nacionalista y exaltaci√≥n de la identidad nacional",
                "questions": [
                    "¬øQu√© s√≠mbolos o valores nacionales se exaltan?",
                    "¬øC√≥mo se presenta la identidad nacional como amenazada?",
                    "¬øQu√© elementos de nacionalismo excluyente se detectan?"
                ]
            },
            Categories.ANTI_GOVERNMENT: {
                "focus": "ret√≥rica anti-gubernamental y deslegitimizaci√≥n institucional",
                "questions": [
                    "¬øQu√© aspectos del gobierno se cuestionan como ileg√≠timos?",
                    "¬øC√≥mo se manifiesta la ret√≥rica anti-establishment?",
                    "¬øSe promueve resistencia o desobediencia institucional?"
                ]
            },
            Categories.HISTORICAL_REVISIONISM: {
                "focus": "reinterpretaci√≥n sesgada de eventos hist√≥ricos",
                "questions": [
                    "¬øQu√© eventos hist√≥ricos se reinterpretan de forma problem√°tica?",
                    "¬øSe rehabilitan figuras o reg√≠menes controvertidos?",
                    "¬øC√≥mo se usa la historia para justificar narrativas actuales?"
                ]
            },
            Categories.POLITICAL_GENERAL: {
                "focus": "contenido pol√≠tico convencional sin elementos extremistas",
                "questions": [
                    "¬øQu√© temas pol√≠ticos se tratan de forma constructiva?",
                    "¬øQu√© perspectiva pol√≠tica moderada se presenta?",
                    "¬øPor qu√© no entra en categor√≠as problem√°ticas espec√≠ficas?"
                ]
            },
            Categories.GENERAL: {
                "focus": "contenido neutral o pol√≠tico moderado sin elementos extremistas",
                "questions": [
                    "¬øPor qu√© este contenido no entra en categor√≠as problem√°ticas?",
                    "¬øQu√© lo hace neutral o moderadamente pol√≠tico?",
                    "¬øFalta contexto extremista, conspirativo o discriminatorio?"
                ]
            }
        }
        
        context = category_context.get(category, category_context[Categories.GENERAL])
        questions_formatted = "\n".join([f"{i+1}. {question}" for i, question in enumerate(context['questions'])])
        
        # Fallback prompt generation (current implementation)
        fallback_prompt = "\n".join([
            f'TEXTO ANALIZADO: "{text}"',
            f'CATEGOR√çA DETECTADA: {category}',
            "",
            "üî¨ AN√ÅLISIS ACAD√âMICO DETALLADO - INVESTIGACI√ìN SOBRE PATRONES DE DISCURSO PROBLEM√ÅTICO",
            "",
            "OBJETIVO: Proporcionar explicaci√≥n detallada para estudio cient√≠fico de contenido moderado en plataformas sociales.",
            "",
            f"AN√ÅLISIS ACAD√âMICO - Enf√≥cate en {context['focus']}:",
            ""
        ] + [f"{i+1}. {question}" for i, question in enumerate(context['questions'])] + [
            "",
            "INSTRUCCIONES DE FORMATO:",
            "- Responde SOLO con texto plano en espa√±ol, sin markdown ni formato especial",
            "- NO uses negritas (**), t√≠tulos (##), listas numeradas, tablas, o s√≠mbolos",
            "- Escribe 2-3 oraciones claras y directas explicando los elementos detectados",
            "- Como si le explicaras a una persona que no conoce el tema",
            "EXPLICACI√ìN:"
        ])
        
        # Get optimized prompt and format with parameters
        optimized_template = self._get_optimized_prompt('local_explanation', fallback_prompt)
        return optimized_template.format(
            text=text, 
            category=category,
            focus=context['focus'],
            questions=questions_formatted
        )

    def generate_classification_prompt(self, text: str, model_type: str = "ollama") -> str:
        """
        Generate classification prompt for determining content category.

        Args:
            text: Text content to classify
            model_type: Type of model being used ("ollama", "transformers", etc.)

        Returns:
            Formatted classification prompt
        """
        all_categories = Categories.get_all_categories()
        category_descriptions = {
            Categories.HATE_SPEECH: "Discurso de odio, xenofobia, amenazas violentas",
            Categories.DISINFORMATION: "Informaci√≥n falsa, datos fabricados, afirmaciones sin evidencia",
            Categories.CONSPIRACY_THEORY: "Teor√≠as conspirativas, narrativas de agenda oculta",
            Categories.FAR_RIGHT_BIAS: "Ret√≥rica extremista, nacionalismo radical, anti-establishment",
            Categories.CALL_TO_ACTION: "Llamadas a movilizaci√≥n, organizaci√≥n de protestas",
            Categories.NATIONALISM: "√ânfasis en identidad nacional, ret√≥rica patri√≥tica",
            Categories.ANTI_GOVERNMENT: "Cr√≠tica institucional, desconfianza en el gobierno",
            Categories.HISTORICAL_REVISIONISM: "Reinterpretaci√≥n hist√≥rica, minimizaci√≥n de atrocidades",
            Categories.POLITICAL_GENERAL: "Discurso pol√≠tico neutral o general",
            Categories.GENERAL: "Contenido neutral sin patrones problem√°ticos"
        }

        category_list = "\n".join([
            f"  - {cat}: {category_descriptions.get(cat, '')}"
            for cat in all_categories
        ])

        prompt = f"""üî¨ INVESTIGACI√ìN ACAD√âMICA - CLASIFICACI√ìN DE CONTENIDO PROBLEM√ÅTICO

OBJETIVO: Clasificar contenido para investigaci√≥n sobre moderaci√≥n de contenido en redes sociales.

Clasifica el siguiente contenido en UNA categor√≠a principal:

CATEGOR√çAS DISPONIBLES:
{category_list}

REGLAS IMPORTANTES:
- hate_speech: Ataques directos a grupos √©tnicos espec√≠ficos identificables
- far_right_bias: Ret√≥rica pol√≠tica extremista, nacionalismo radical, cr√≠ticas a partidos por favorecer "de fuera" sobre "de dentro"
- disinformation: Informaci√≥n falsa sobre ciencia/medicina (NO pol√≠tica)
- conspiracy_theory: Teor√≠as sobre control secreto no pol√≠tico
- call_to_action: Llamadas expl√≠citas a movilizaci√≥n colectiva
- political_general: Contenido pol√≠tico neutral sin extremismo
- general: Contenido neutral sin elementos problem√°ticos

CONTENIDO: {text}

IMPORTANTE: Si contiene cr√≠ticas pol√≠ticas extremas, acusaciones contra pol√≠ticos, o lenguaje que divide "nosotros vs ellos" ‚Üí far_right_bias
IMPORTANTE: Frases como "coraz√≥n gigante para los de fuera" o "calamidad para Espa√±a" ‚Üí far_right_bias
IMPORTANTE: Acusaciones de corrupci√≥n o v√≠nculos con dictadores ‚Üí far_right_bias

FORMATO OBLIGATORIO:
CATEGOR√çA: [nombre_categor√≠a]
EXPLICACI√ìN: [1-2 frases explicando por qu√© pertenece a esa categor√≠a]"""

        return prompt